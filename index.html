<!-- üîß FF-BLOCK-1: HTML BASE Y METADATOS -->
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description"
    content="Genera ideas impactantes para redes sociales con IA. Usa FeedFlow, una app creativa, profesional y visualmente atractiva." />
  <title>FeedFlow ‚Äì Ideas con IA</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <!-- üîß FF-BLOCK-2: LIBRER√çAS CSS Y ESTILO -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root {
      --ff-morado: #8e44ad;
      --ff-dorado: #f1c40f;
      --ff-fondo: #fdfdfd;
      --ff-degradado: linear-gradient(to right, #8e44ad, #f39c12);
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--ff-fondo);
      color: #333;
    }

    .ff-logo {
      font-size: 2rem;
      font-weight: bold;
      color: var(--ff-morado);
    }

    .ff-gradient {
      background: var(--ff-degradado);
      color: white;
    }

    .ff-section {
      padding: 2rem 1rem;
    }

    .is-hidden {
      display: none !important;
    }
  </style>
</head>

<body>
  <!-- üîß FF-BLOCK-3: ESTRUCTURA HTML -->
  <section id="ff-auth-view" class="ff-section">
    <div class="container">
      <h1 class="title has-text-centered ff-logo">FeedFlow</h1>
      <p class="subtitle has-text-centered" id="auth-title">Inicia sesi√≥n para comenzar</p>

      <div class="buttons is-centered">
        <button id="ff-google-login" class="button is-light">
          <span class="icon"><i class="fab fa-google"></i></span>
          <span>Google</span>
        </button>
        <button id="ff-email-login" class="button is-link">Email</button>
      </div>

      <p id="toggle-auth-text" class="has-text-centered mt-4"></p>

      <div id="ff-signup-form-container" class="box is-hidden">
        <div class="field">
          <label class="label">Nombre</label>
          <div class="control"><input id="ff-name" class="input" type="text"></div>
        </div>
        <div class="field">
          <label class="label">Apellido</label>
          <div class="control"><input id="ff-lastname" class="input" type="text"></div>
        </div>
        <div class="field">
          <label class="label">Correo</label>
          <div class="control"><input id="ff-email" class="input" type="email"></div>
        </div>
        <div class="field">
          <label class="label">Contrase√±a</label>
          <div class="control"><input id="ff-password" class="input" type="password"></div>
        </div>
        <button id="ff-register-btn" class="button is-success mt-3">Crear cuenta</button>
      </div>
    </div>
  </section>

  <div class="control"><input id="ff-keyword" class="input" type="text"></div>
  </div>

  <!-- Tipo de publicaci√≥n -->
  <div class="field">
    <label class="label">Tipo de publicaci√≥n</label>
    <div class="control">
      <div class="select is-fullwidth">
        <select id="ff-copy-type">               
          <option>Persuasivo</option>
          <option>De beneficio</option> 
          <option>De novedad o lanzamiento</option>    
          <option>De interaccion o pregunta</option>          
          <option>De urgencia o escacez</option>                         
          <option>Educativo</option>
          <option>Formal</option>     
          <option>Informativo</option>
          <option>Informal</option>    
          <option>Llamada a la Acci√≥n (CTA)</option>                        
          <option>Narrativo o storytelling</option>
          <option>Posicionamiento o branding</option>          
          <option>Testimonio o prueba social</option>          
          <option>T√©cnico o profesional</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Redes sociales -->
  <div class="field">
    <label class="label">Redes sociales</label>
    <p class="help" id="ff-social-help">Selecciona una o m√°s redes sociales seg√∫n el modo elegido.</p>
    <div class="control" id="ff-socials">
      <label class="checkbox mr-3"><input type="checkbox" value="Instagram" class="ff-social"> Instagram</label>
      <label class="checkbox mr-3"><input type="checkbox" value="Facebook" class="ff-social"> Facebook</label>
      <label class="checkbox mr-3"><input type="checkbox" value="TikTok" class="ff-social"> TikTok</label>
      <label class="checkbox mr-3"><input type="checkbox" value="X" class="ff-social"> X</label>
      <label class="checkbox mr-3"><input type="checkbox" value="LinkedIn" class="ff-social"> LinkedIn</label>
      <label class="checkbox"><input type="checkbox" value="YouTube" class="ff-social"> YouTube</label>
    </div>
  </div>

  <!-- Modo de generaci√≥n -->
  <div class="field">
    <label class="label">¬øC√≥mo quieres generar ideas?</label>
    <div class="control">
      <div class="select is-fullwidth">
        <select id="ff-generation-mode">
          <option value="multired">Una idea por red social seleccionada (Multired)</option>
          <option value="individual">Tres ideas para una sola red (Individual)</option>
        </select>
      </div>
    </div>
    <p class="help" id="ff-mode-help">Selecciona una red si quieres 3 ideas, o varias para una idea por cada una.</p>
  </div>

  <!-- Idioma (esto luego lo moveremos post-login) -->
  <div class="field">
    <label class="label">Idioma</label>
    <div class="control">
      <div class="select">
        <select id="ff-language">
          <option value="es">Espa√±ol</option>
          <option value="en">Ingl√©s</option>
          <option value="pt">Portugu√©s</option>
        </select>
      </div>
    </div>
  </div>

  <button id="ff-generate-btn" class="button is-primary mt-4">Generar ideas</button>
  </div>
  </section>

  <section id="ff-results-view" class="ff-section is-hidden">
    <div class="container">
      <h2 class="title">Ideas generadas</h2>
      <div id="ff-ideas-output" class="content"></div>
      <button id="ff-back-to-config" class="button is-light mt-3">Volver</button>
    </div>
  </section>

  <!-- Modal Feedback -->
  <div class="modal" id="ff-feedback-modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="box">
        <p>¬øEsta idea te fue √∫til?</p>
        <div class="buttons is-centered mt-3">
          <button class="button is-success ff-feedback-btn" data-feedback="like"><i
              class="fas fa-thumbs-up"></i></button>
          <button class="button is-danger ff-feedback-btn" data-feedback="dislike"><i
              class="fas fa-thumbs-down"></i></button>
        </div>
      </div>
    </div>
    <button class="modal-close is-large" aria-label="close" id="ff-close-feedback"></button>
  </div>

  <section id="ff-admin-view" class="ff-section is-hidden">
    <div class="container">
      <h2 class="title">Control Admin ‚Äì Premium Global</h2>
      <div class="field">
        <label class="checkbox"><input type="checkbox" id="ff-toggle-premium-global"> Activar Premium Global</label>
      </div>
      <div class="field">
        <label class="label">Fecha de expiraci√≥n</label>
        <div class="control"><input type="datetime-local" id="ff-premium-end-date" class="input"></div>
      </div>
      <button id="ff-set-premium-btn" class="button is-warning mt-2">Actualizar</button>
      <p id="ff-premium-status-text" class="mt-3"></p>
    </div>
  </section>
  <!-- üîß FF-BLOCK-4: TRADUCCIONES INTERNACIONALES -->
  <script>
    const translations = {
      es: {
        'auth-title': 'Inicia sesi√≥n para comenzar',
        'show-login-form-link': '¬øYa tienes cuenta? Inicia sesi√≥n',
        'toggle-auth-text-login': '¬øNo tienes cuenta?',
        'back': 'Volver',
        'generate': 'Generar ideas',
        'premium-global-active': 'Premium Global activo hasta:',
      },
      en: {
        'auth-title': 'Log in to get started',
        'show-login-form-link': 'Already have an account? Log in',
        'toggle-auth-text-login': 'Don‚Äôt have an account?',
        'back': 'Back',
        'generate': 'Generate ideas',
        'premium-global-active': 'Global Premium active until:',
      },
      pt: {
        'auth-title': 'Fa√ßa login para come√ßar',
        'show-login-form-link': 'J√° tem uma conta? Entre',
        'toggle-auth-text-login': 'Ainda n√£o tem conta?',
        'back': 'Voltar',
        'generate': 'Gerar ideias',
        'premium-global-active': 'Premium Global ativo at√©:',
      },
    };

    let currentLang = localStorage.getItem('ff-lang') || 'es';

    function t(key) {
      return translations[currentLang]?.[key] || key;
    }

    function setLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('ff-lang', lang);
      document.getElementById('auth-title').textContent = t('auth-title');
      document.getElementById('toggle-auth-text').innerHTML = `${t('toggle-auth-text-login')} <a id="show-login-form-link">${t('show-login-form-link')}</a>`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById('ff-language').value = currentLang;
      document.getElementById('ff-language').addEventListener('change', (e) => {
        setLanguage(e.target.value);
      });
      setLanguage(currentLang);
    });
  </script>
  <!-- üîß FF-BLOCK-5: AUTHENTICACI√ìN Y SESI√ìN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      signInWithPopup,
      GoogleAuthProvider,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      doc, setDoc, getDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { httpsCallable, getFunctions } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCScJA-UGs3WcBnfAm-6K94ybZ4bzBahz8",
      authDomain: "brain-storm-8f0d8.firebaseapp.com",
      databaseURL: "https://brain-storm-8f0d8-default-rtdb.firebaseio.com",
      projectId: "brain-storm-8f0d8",
      storageBucket: "brain-storm-8f0d8.appspot.com",
      messagingSenderId: "401208607043",
      appId: "1:401208607043:web:6f35fc81fdce7b3fbeaff6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app);

    let sessionId = Date.now().toString();
    let deviceId = localStorage.getItem('ff-device-id') || crypto.randomUUID();
    localStorage.setItem('ff-device-id', deviceId);

    async function registerSession(user) {
      const register = httpsCallable(functions, 'registerUserSession');
      await register({ uid: user.uid, sessionId, deviceId });
    }

    async function checkSession(user) {
      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);
      if (userSnap.exists()) {
        const sessions = userSnap.data().sessions || [];
        const isSessionValid = sessions.some(s => s.sessionId === sessionId && s.deviceId === deviceId);
        if (!isSessionValid) {
          alert("Se cerr√≥ la sesi√≥n en este dispositivo.");
          await signOut(auth);
          location.reload();
        }
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        await registerSession(user);
        await checkSession(user);
        document.getElementById("ff-auth-view").classList.add("is-hidden");
        document.getElementById("ff-config-view").classList.remove("is-hidden");
      } else {
        document.getElementById("ff-auth-view").classList.remove("is-hidden");
        document.getElementById("ff-config-view").classList.add("is-hidden");
        document.getElementById("ff-results-view").classList.add("is-hidden");
      }
    });

    document.getElementById("ff-google-login").addEventListener("click", async () => {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    });
  </script>
  <!-- üîß FF-BLOCK-6: GENERACI√ìN DE IDEAS CON IA -->
  <script type="module">
    document.getElementById("ff-generate-btn").addEventListener("click", async () => {
      const keyword = document.getElementById("ff-keyword").value;
      const copyType = document.getElementById("ff-copy-type").value;
      const mode = document.getElementById("ff-generation-mode").value;
      const language = document.getElementById("ff-language").value;
      const socialElems = document.querySelectorAll(".ff-social:checked");
      const socialNetworks = Array.from(socialElems).map(e => e.value);

      if (!keyword || socialNetworks.length === 0) {
        alert("Por favor, completa los campos requeridos.");
        return;
      }

      const generateIdeas = httpsCallable(functions, 'generateIdeas');
      const result = await generateIdeas({
        keyword,
        copyType,
        mode,
        language,
        socialNetworks,
        sessionId
      });

      const output = document.getElementById("ff-ideas-output");
      output.innerHTML = "";
      result.data.ideas.forEach((idea, idx) => {
        const box = document.createElement("div");
        box.className = "box";
        box.innerHTML = `
        <h3 class="title is-5">Idea ${idx + 1}</h3>
        <p><strong>Gancho:</strong> ${idea.hook}</p>
        <p><strong>√Ångulo:</strong> ${idea.angle}</p>
        <p><strong>Texto:</strong> ${idea.body}</p>
        <p><strong>CTA:</strong> ${idea.cta}</p>
        <p><strong>Motivaci√≥n:</strong> ${idea.motivation}</p>
        <p><strong>Hashtags:</strong> ${idea.hashtags.join(' ')}</p>
        <p><strong>Formato visual sugerido:</strong> ${idea.visual}</p>
        <button class="button is-small is-info mt-2 ff-feedback-btn" data-feedback="like">üëç</button>
        <button class="button is-small is-danger mt-2 ff-feedback-btn" data-feedback="dislike">üëé</button>
      `;
        output.appendChild(box);
      });

      document.getElementById("ff-config-view").classList.add("is-hidden");
      document.getElementById("ff-results-view").classList.remove("is-hidden");
    });

    document.getElementById("ff-back-to-config").addEventListener("click", () => {
      document.getElementById("ff-results-view").classList.add("is-hidden");
      document.getElementById("ff-config-view").classList.remove("is-hidden");
    });
  </script>
  <script type="module">
    document.getElementById("ff-generation-mode").addEventListener("change", (e) => {
      const mode = e.target.value;
      const checkboxes = document.querySelectorAll(".ff-social");

      if (mode === "individual") {
        checkboxes.forEach(cb => cb.checked = false);
      }

      checkboxes.forEach(cb => {
        cb.disabled = false;
        cb.addEventListener("change", () => {
          if (mode === "individual") {
            checkboxes.forEach(other => {
              if (other !== cb) other.checked = false;
            });
          }
        });
      });
    });
  </script>
  <!-- üîß FF-BLOCK-7: FEEDBACK DE IDEAS -->
  <script type="module">
    document.addEventListener("click", async (e) => {
      if (e.target.classList.contains("ff-feedback-btn")) {
        const feedbackType = e.target.dataset.feedback;
        const ideaIndex = Array.from(document.querySelectorAll(".ff-feedback-btn")).indexOf(e.target);
        const recordFeedback = httpsCallable(functions, "recordIdeaFeedback");

        try {
          await recordFeedback({
            sessionId,
            feedback: feedbackType,
            ideaIndex
          });
          alert("¬°Gracias por tu opini√≥n!");
        } catch (error) {
          console.error("Error enviando feedback:", error);
          alert("Error al enviar feedback.");
        }
      }
    });

    document.getElementById("ff-close-feedback")?.addEventListener("click", () => {
      document.getElementById("ff-feedback-modal").classList.remove("is-active");
    });
  </script>
  <!-- üîß FF-BLOCK-8: CONTROL DE PREMIUM Y PUBLICIDAD -->
  <script type="module">
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    async function checkPremiumStatus(uid) {
      const configRef = doc(db, "appConfig", "global");
      const configSnap = await getDoc(configRef);
      const userRef = doc(db, "users", uid);
      const userSnap = await getDoc(userRef);

      let isPremium = false;
      let showAds = true;

      if (userSnap.exists()) {
        isPremium = userSnap.data().premium || false;
      }

      if (configSnap.exists()) {
        const global = configSnap.data();
        const now = new Date();
        const endDate = new Date(global.premiumGlobalEndDate);
        if (global.isPremiumGlobalActive && now < endDate) {
          isPremium = true;
          showAds = global.isLaunchPromoActive; // En promo se permiten ads completas
        }
      }

      if (!isPremium) {
        // Mostrar publicidad completa
        const ad = document.createElement("div");
        ad.className = "notification is-warning has-text-centered";
        ad.innerHTML = "Publicidad: ¬°Explora nuestra versi√≥n Premium sin anuncios!";
        document.body.appendChild(ad);
      } else if (showAds) {
        // Mostrar publicidad discreta
        const ad = document.createElement("div");
        ad.className = "has-text-centered has-text-grey-light";
        ad.innerHTML = "<small>Publicidad moderada activa por promoci√≥n.</small>";
        document.body.appendChild(ad);
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) await checkPremiumStatus(user.uid);
    });
  </script>
  <!-- üîß FF-BLOCK-9: PANEL ADMIN PREMIUM -->
  <script type="module">
    document.getElementById("ff-set-premium-btn").addEventListener("click", async () => {
      const isActive = document.getElementById("ff-toggle-premium-global").checked;
      const endDate = document.getElementById("ff-premium-end-date").value;

      const setPremiumGlobal = httpsCallable(functions, "setPremiumGlobalStatus");
      try {
        await setPremiumGlobal({
          isPremiumGlobalActive: isActive,
          premiumGlobalEndDate: new Date(endDate).toISOString()
        });
        document.getElementById("ff-premium-status-text").textContent =
          `${t('premium-global-active')} ${new Date(endDate).toLocaleString()}`;
        alert("Actualizaci√≥n exitosa.");
      } catch (error) {
        console.error("Error actualizando premium global:", error);
        alert("Error al actualizar estado global.");
      }
    });
  </script>
  <!-- üîß FF-BLOCK-10: ENLACES ADICIONALES -->
  <!-- Puedes agregar aqu√≠ enlaces a redes sociales, blog o bot√≥n para recomendar la app -->
  <footer class="footer has-text-centered mt-5">
    <p><strong>FeedFlow</strong> ‚Äì Genera ideas con IA | <a href="#">Pol√≠tica de Privacidad</a></p>
    <p><small>Desarrollado con üí° en Latinoam√©rica</small></p>
  </footer>
  <!-- üîß FF-BLOCK-11: VISUAL PROMPT REFERENCIA -->
  <script>
    function construirPromptVisual(idea) {
      return `Estilo: ${idea.style || "ilustraci√≥n vectorial"}, fondo: ${idea.background || "minimalista"}, personaje: ${idea.character || "joven usando celular"}, emoci√≥n: ${idea.emotion || "inspiraci√≥n"}, red social: ${idea.platform || "TikTok"}, orientaci√≥n: vertical.`;
    }
  </script>
  <!-- üîß FF-BLOCK-12: ADMIN AVANZADO -->
  <script type="module">
    async function validarAdmin(uid) {
      const userRef = doc(db, "users", uid);
      const userSnap = await getDoc(userRef);
      if (userSnap.exists() && userSnap.data().role === "admin") {
        document.getElementById("ff-admin-view").classList.remove("is-hidden");
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) await validarAdmin(user.uid);
    });
  </script>
  <!-- üîß FF-BLOCK-13: CIERRE HTML -->
</body>

</html>
