<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador de Ideas para Contenido</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js">

exportPdfButton.addEventListener('click', () => {
  const originalButtonText = exportPdfButton.innerHTML;
  exportPdfButton.innerHTML = "Generando PDF...";
  exportPdfButton.disabled = true;

  const clone = ideasResultsArea.cloneNode(true);
  clone.style.backgroundColor = "white";
  clone.style.padding = "40px";
  clone.style.width = "100%";
  clone.style.maxWidth = "800px";
  clone.style.margin = "0 auto";

  clone.classList.add("pdf-export-preview");

  document.body.appendChild(clone);

  setTimeout(() => {
    console.log("Exportando PDF desde HTML directamente...");

    html2pdf().from(clone).set({
      margin: 0.5,
      filename: `ideas_generadas_${new Date().toISOString().split("T")[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.95 },
      html2canvas: {
        scale: 2,
        useCORS: true
      },
      jsPDF: {
        unit: 'in',
        format: 'letter',
        orientation: 'portrait'
      },
      pagebreak: {
        mode: ['css', 'legacy'],
        before: '.card'
      }
    }).save().then(() => {
      console.log("✅ PDF generado correctamente.");
    }).catch(err => {
      console.error("❌ Error al generar el PDF:", err);
      showTemporaryMessage(actionButtonsContainer, "Error al generar PDF. Revisa consola.", 'is-danger', 4000);
    }).finally(() => {
      exportPdfButton.innerHTML = originalButtonText;
      exportPdfButton.disabled = false;
      if (clone.parentNode) document.body.removeChild(clone);
    });

  }, 100);
});

});

</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js">

exportPdfButton.addEventListener('click', () => {
  const originalButtonText = exportPdfButton.innerHTML;
  exportPdfButton.innerHTML = "Generando PDF...";
  exportPdfButton.disabled = true;

  const clone = ideasResultsArea.cloneNode(true);
  clone.style.backgroundColor = "white";
  clone.style.padding = "40px";
  clone.style.width = "100%";
  clone.style.maxWidth = "800px";
  clone.style.margin = "0 auto";

  clone.classList.add("pdf-export-preview");

  document.body.appendChild(clone);

  setTimeout(() => {
    console.log("Exportando PDF desde HTML directamente...");

    html2pdf().from(clone).set({
      margin: 0.5,
      filename: `ideas_generadas_${new Date().toISOString().split("T")[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.95 },
      html2canvas: {
        scale: 2,
        useCORS: true
      },
      jsPDF: {
        unit: 'in',
        format: 'letter',
        orientation: 'portrait'
      },
      pagebreak: {
        mode: ['css', 'legacy'],
        before: '.card'
      }
    }).save().then(() => {
      console.log("✅ PDF generado correctamente.");
    }).catch(err => {
      console.error("❌ Error al generar el PDF:", err);
      showTemporaryMessage(actionButtonsContainer, "Error al generar PDF. Revisa consola.", 'is-danger', 4000);
    }).finally(() => {
      exportPdfButton.innerHTML = originalButtonText;
      exportPdfButton.disabled = false;
      if (clone.parentNode) document.body.removeChild(clone);
    });

  }, 100);
});

});

</script>

  <style>
    /* Estilos personalizados (los mismos que antes, mantenlos) */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f7f6;
      color: #363636;
    }

    .navbar {
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* ... (resto de tus estilos CSS se mantienen) ... */
    .footer {
      background-color: #363636;
      color: #fff;
      padding: 3rem 1.5rem 3rem;
    }

    .footer a {
      color: #ff6f61;
    }

    .footer a:hover {
      color: #e65a50;
    }

    .disclaimer {
      font-size: 0.8rem;
      color: #ccc;
      margin-top: 1rem;
    }

    .generation-status-message {
      /* Para el mensaje de cuántas ideas se generaron */
      font-weight: bold;
    }

    .card .content p,
    .card .content strong,
    .card-header-title {
      color: #2c3e50 !important;
      /* Un color oscuro y legible */
      background-color: transparent !important;
      /* Asegurar que no haya fondos extraños para el texto en sí */
    }

    .card {
      background-color: white !important;
      /* Asegurar que la tarjeta tenga un fondo opaco */
      /* Puedes añadir un borde si quieres verlo claramente en el PDF */
      /* border: 1px solid #dbdbdb; */
    }

    /* Para asegurar que el contenedor principal también tenga fondo si es necesario */
    #ideasResultsArea {
      background-color: white;
      /* O el color de fondo de tu appView si es diferente */
    }
  </style>
</head>

<body>
  <div id="loadingOverlay" class="is-hidden">
    <div class="loader is-loading"></div>
    <p style="margin-left: 10px;">Cargando...</p>
  </div>

  <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
      <a class="navbar-item" href="#">
        <strong class="title is-4">Brain Storm</strong>
      </a>
      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarMenuCore">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div id="navbarMenuCore" class="navbar-menu">
      <div class="navbar-start">
      </div>

      <div class="navbar-end">
        <div class="navbar-item">
          <div class="buttons">
            <a id="navRegisterButton" class="button is-primary"> <strong>Registrarse</strong>
            </a>
            <a id="navLoginButton" class="button is-light"> Iniciar Sesión
            </a>
            <button id="navHistoryButton" class="button is-link is-hidden"> <span class="icon"><i
                  class="fas fa-history"></i></span>
              <span>Historial</span>
            </button>
            <button id="navLogoutButton" class="button is-danger is-hidden"> <span class="icon"><i
                  class="fas fa-sign-out-alt"></i></span>
              <span>Cerrar Sesión</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <section id="authView" class="section">
    <div class="container">
      <div class="columns is-centered">
        <div class="column is-half">
          <div id="loginBox">
            <h2 class="title is-3 has-text-centered">Iniciar Sesión</h2>
            <form id="loginForm" class="box">
              <div class="field">
                <label class="label" for="loginEmail">Correo Electrónico</label>
                <div class="control has-icons-left">
                  <input class="input" type="email" id="loginEmail" placeholder="tu@correo.com" required>
                  <span class="icon is-small is-left">
                    <i class="fas fa-envelope"></i>
                  </span>
                </div>
              </div>
              <div class="field">
                <label class="label" for="loginPassword">Contraseña</label>
                <div class="control has-icons-left">
                  <input class="input" type="password" id="loginPassword" placeholder="********" required>
                  <span class="icon is-small is-left">
                    <i class="fas fa-lock"></i>
                  </span>
                </div>
              </div>
              <div id="loginError" class="has-text-danger mb-2"></div> <button type="submit"
                class="button is-primary is-fullwidth">Entrar</button>
            </form>
            <p class="has-text-centered mt-4">
              ¿No tienes cuenta? <a href="#" id="showRegisterLink">Regístrate aquí</a>
            </p>
          </div>

          <div id="registerBox" class="is-hidden">
            <h2 class="title is-3 has-text-centered">Crear Cuenta</h2>
            <form id="registerForm" class="box">
              <div class="field">
                <label class="label" for="registerName">Nombre (opcional)</label>
                <div class="control has-icons-left">
                  <input class="input" type="text" id="registerName" placeholder="Tu Nombre">
                  <span class="icon is-small is-left">
                    <i class="fas fa-user"></i>
                  </span>
                </div>
              </div>
              <div class="field">
                <label class="label" for="registerEmail">Correo Electrónico</label>
                <div class="control has-icons-left">
                  <input class="input" type="email" id="registerEmail" placeholder="tu@correo.com" required>
                  <span class="icon is-small is-left">
                    <i class="fas fa-envelope"></i>
                  </span>
                </div>
              </div>
              <div class="field">
                <label class="label" for="registerPassword">Contraseña</label>
                <div class="control has-icons-left">
                  <input class="input" type="password" id="registerPassword" placeholder="********" required>
                  <span class="icon is-small is-left">
                    <i class="fas fa-lock"></i>
                  </span>
                </div>
              </div>
              <div id="registerError" class="has-text-danger mb-2"></div> <button type="submit"
                class="button is-success is-fullwidth">Crear Cuenta</button>
            </form>
            <p class="has-text-centered mt-4">
              ¿Ya tienes cuenta? <a href="#" id="showLoginLink">Inicia sesión aquí</a>
            </p>
          </div>

          <div class="divider">O</div>

          <button id="googleLoginButton" class="button is-danger is-fullwidth mt-4">
            <span class="icon"><i class="fab fa-google"></i></span>
            <span>Continuar con Google</span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <section id="appView" class="section is-hidden">
    <div class="container">
      <h1 class="title is-2" id="greeting">¡Hola!</h1>
      <p class="subtitle">Vamos a generar ideas increíbles para tu contenido.</p>

      <div class="columns">
        <div class="column is-one-third">
          <div id="formView">
            <div class="box">
              <div class="field">
                <label class="label" for="topicInput">Tema o Palabra Clave Principal</label>
                <div class="control">
                  <input class="input" list="topicSuggestions" type="text" id="topicInput"
                    placeholder="Ej: Marketing Digital para Principiantes">
                  <datalist id="topicSuggestions"></datalist>
                </div>
                <p class="coach-motivation">✨ ¡Sé preciso! Cuanto más preciso sea tu tema, más
                  brillantes serán las ideas. ✨</p>
              </div>

              <div class="field">
                <label class="label" for="copyTypeSelect">Tipo de Copy / Post</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="copyTypeSelect">
                      <option value="promocional" selected>Copy promocional</option>
                      <option value="informativo">Copy informativo</option>
                      <option value="emocional">Copy emocional</option>
                      <option value="cta">Copy con llamado a la acción (CTA)</option>
                      <option value="autoridad">Copy de autoridad o prueba social</option>
                      <option value="narrativo">Copy narrativo o storytelling</option>
                      <option value="urgencia">Copy de urgencia o escasez</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="field">
                <label class="label">Redes Sociales (selecciona una o varias)</label>
                <div id="socialNetworksContainer" class="control">
                  <label class="checkbox mr-2 mb-2">
                    <input type="checkbox" name="socialNetwork" value="Instagram"> Instagram
                  </label>
                  <label class="checkbox mr-2 mb-2">
                    <input type="checkbox" name="socialNetwork" value="Facebook"> Facebook
                  </label>
                  <label class="checkbox mr-2 mb-2">
                    <input type="checkbox" name="socialNetwork" value="X / Twitter"> X / Twitter
                  </label>
                  <label class="checkbox mr-2 mb-2">
                    <input type="checkbox" name="socialNetwork" value="LinkedIn"> LinkedIn
                  </label>
                  <label class="checkbox mr-2 mb-2">
                    <input type="checkbox" name="socialNetwork" value="TikTok"> TikTok
                  </label>
                  <label class="checkbox mr-2 mb-2">
                    <input type="checkbox" name="socialNetwork" value="YouTube"> YouTube
                  </label>
                  <label class="checkbox mr-2 mb-2">
                    <input type="checkbox" name="socialNetwork" value="Google Ads"> Google Ads
                  </label>
                </div>
              </div>

              <div class="field mt-5">
                <button id="generateIdeasButton"
                  class="button is-primary is-fullwidth is-large animate__animated animate__pulse animate__infinite">
                  <span class="icon"><i class="fas fa-lightbulb"></i></span>
                  <span>✨ ¡Generar Ideas! ✨</span>
                </button>
              </div>

              <div class="field mt-3">
                <button id="loadLastSearchButton" class="button is-text is-small is-fullwidth">Cargar
                  última configuración</button>
              </div>
            </div>
            <div class="field mt-3">
              <button id="exportUserHistoryCsvButton" class="button is-link is-outlined is-fullwidth">
                <span class="icon"><i class="fas fa-download"></i></span>
                <span>Exportar Últimas 50 Generaciones (CSV)</span>
              </button>
            </div>
          </div>
        </div>
        <div id="resultsView" class="column">
          <div id="actionButtonsContainer" class="mb-4 is-hidden has-text-right">
            <button id="backToFormButton" class="button is-light mr-2">
              <span class="icon"><i class="fas fa-arrow-left"></i></span>
              <span>Nueva Generación</span>
            </button>
            <button id="exportPdfButton" class="button is-success mr-2">
              <span class="icon"><i class="fas fa-file-pdf"></i></span>
              <span>Exportar a PDF</span>
            </button>
          </div>

          <div id="ideasResultsArea">
            <p id="noResultsMessage" class="has-text-centered has-text-grey">Completa los campos y haz clic
              en generar.</p>
          </div>

          <div id="finalPhraseContainer" class="is-hidden mt-4">
            <p id="finalPhraseText" class="has-text-centered is-italic"></p>
          </div>

          <div id="timerContainer" class="has-text-centered my-2"></div>
        </div>
      </div>
    </div>

    <div id="historyModal" class="modal">
    </div>

    <footer class="footer">
    </footer>

    <script type="module">
      // Importaciones de Firebase (sin cambios)
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; // Quité writeBatch ya que limitUserHistory usa admin SDK
      import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";


      // Configuración de Firebase (sin cambios)
      const firebaseConfig = {
        apiKey: "AIzaSyA6MZwE3_4K6CU0JTDVBG_c5GCgX5I00VE",
        authDomain: "brain-storm-8f0d8.firebaseapp.com",
        projectId: "brain-storm-8f0d8",
        storageBucket: "brain-storm-8f0d8.appspot.com",
        messagingSenderId: "401208607043",
        appId: "1:401208607043:web:6b4038ab14c9bee3beaff6"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

const functions = getFunctions(app, 'us-central1');


      const db = getFirestore(app);
      const functions = getFunctions(app);

      // Selectores del DOM (algunos ya no se necesitarán)
      const loadingOverlay = document.getElementById('loadingOverlay');
      const authView = document.getElementById('authView');
      const appView = document.getElementById('appView');
      const greeting = document.getElementById('greeting');
      const navLoginButton = document.getElementById('navLoginButton');
      const navRegisterButton = document.getElementById('navRegisterButton');
      const navHistoryButton = document.getElementById('navHistoryButton');
      const navLogoutButton = document.getElementById('navLogoutButton');
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const googleLoginButton = document.getElementById('googleLoginButton');
      const loginError = document.getElementById('loginError'); // Para mostrar errores de login
      const registerError = document.getElementById('registerError'); // Para mostrar errores de registro
      const showRegisterLink = document.getElementById('showRegisterLink');
      const showLoginLink = document.getElementById('showLoginLink');
      const loginBox = document.getElementById('loginBox');
      const registerBox = document.getElementById('registerBox');
      // ... (otros selectores como login, register, navbar buttons se mantienen)

      const topicInput = document.getElementById('topicInput');
      const copyTypeSelect = document.getElementById('copyTypeSelect');
      const socialNetworksContainer = document.getElementById('socialNetworksContainer'); // NUEVO (para mensajes de error)
      const generateIdeasButton = document.getElementById('generateIdeasButton');
      const loadLastSearchButton = document.getElementById('loadLastSearchButton'); // NUEVO
      const exportUserHistoryCsvButton = document.getElementById('exportUserHistoryCsvButton'); // NUEVO
      const topicSuggestions = document.getElementById('topicSuggestions'); // NUEVO (el <datalist>)
      const formView = document.getElementById('formView'); // NUEVO
      const resultsView = document.getElementById('resultsView'); // NUEVO
      const ideasResultsArea = document.getElementById('ideasResultsArea');
      const noResultsMessage = document.getElementById('noResultsMessage');
      const finalPhraseContainer = document.getElementById('finalPhraseContainer');
      const finalPhraseText = document.getElementById('finalPhraseText');
      const actionButtonsContainer = document.getElementById('actionButtonsContainer');
      const backToFormButton = document.getElementById('backToFormButton'); // NUEVO
      const exportPdfButton = document.getElementById('exportPdfButton'); // Ya existía
      const timerContainer = document.getElementById('timerContainer'); // NUEVO

      // ... (selectores de historial y variables globales como currentUser se mantienen) ...
      let currentUser = null;
      let currentViewingSessionId = null; // Para saber qué sesión se está viendo o se acaba de generar
      let lastInputData = null; // Para "cargar última configuración" (NUEVO)

      const loadingPhrases = [ // NUEVO para el indicador de carga
        "Desatando la creatividad...",
        "Buscando la chispa de inspiración...",
        "Cocinando ideas frescas...",
        "Conectando neuronas creativas...",
        "Explorando el universo de las ideas...",
        "Puliendo conceptos brillantes...",
        "Tejiendo palabras que impactan...",
        "Dando forma a tu próxima gran idea...",
        "Afinando la estrategia de contenido...",
        "Generando magia para tus redes..."
      ];
      let phrasesIntervalId = null; // NUEVO para el indicador de carga
      // --- Funciones Auxiliares (showLoading, showTemporaryMessage, updateUIForAuthState sin cambios mayores) ---
      function showLoading(show) { /* ... sin cambios ... */ }
      function showTemporaryMessage(element, message, bulmaClass = 'is-danger', duration = 4000) { /* ... sin cambios ... */ }
      function updateUIForAuthState(user) { /* ... sin cambios, pero ahora llamará a clearSimplifiedGenerationForm ... */
        currentUser = user;
        if (user) {
          authView.classList.add('is-hidden');
          appView.classList.remove('is-hidden');
          greeting.textContent = `¡Hola, ${user.displayName || user.email}!`;
          navLoginButton.classList.add('is-hidden');
          navRegisterButton.classList.add('is-hidden');
          navHistoryButton.classList.remove('is-hidden');
          navLogoutButton.classList.remove('is-hidden');
          clearSimplifiedGenerationForm(); // <--- Usar la nueva función de limpiar
          clearResultsArea();
          currentViewingSessionId = null;
        } else {
          // ... (resto sin cambios)
          authView.classList.remove('is-hidden');
          appView.classList.add('is-hidden');
          greeting.textContent = '¡Hola!';
          navLoginButton.classList.remove('is-hidden');
          navRegisterButton.classList.remove('is-hidden');
          navHistoryButton.classList.add('is-hidden');
          navLogoutButton.classList.add('is-hidden');
          loginError.textContent = '';
          registerError.textContent = '';
          currentViewingSessionId = null;
        }
      }

      function clearSimplifiedGenerationForm() {
        topicInput.value = '';
        copyTypeSelect.value = 'promocional'; // Valor por defecto del nuevo select de Tipo de Copy

        // Limpiar todas las casillas de redes sociales
        document.querySelectorAll('input[name="socialNetwork"]:checked').forEach(checkbox => {
          checkbox.checked = false;
        });
        // Opcional: podrías decidir si quieres que `lastInputData` se limpie aquí o no.
        // Si quieres que se limpie para que "cargar última" no recuerde nada tras un logout/login:
        // lastInputData = null;
        // localStorage.removeItem('lastInputData');
      }

      function clearResultsArea() { /* ... sin cambios ... */ }


      // --- Lógica de Autenticación (sin cambios) ---
      onAuthStateChanged(auth, updateUIForAuthState);
      // ... (todo el código de login, registro, google login, logout se mantiene igual) ...
      if (navLogoutButton) { // Buena práctica: verificar que el elemento existe
        navLogoutButton.addEventListener('click', async () => {
          try {
            await signOut(auth); // Llama a la función de Firebase para cerrar sesión
            console.log("Usuario cerró sesión exitosamente.");
            // updateUIForAuthState se llamará automáticamente gracias a onAuthStateChanged
          } catch (error) {
            console.error("Error al cerrar sesión:", error);
            // showTemporaryMessage(algúnElementoParaMensajes, `Error al cerrar sesión: ${error.message}`, 'is-danger');
          }
        });
      }
      if (showRegisterLink && showLoginLink && loginBox && registerBox) {
        showRegisterLink.addEventListener('click', (e) => {
          e.preventDefault();
          loginBox.classList.add('is-hidden');
          registerBox.classList.remove('is-hidden');
        });

        showLoginLink.addEventListener('click', (e) => {
          e.preventDefault();
          registerBox.classList.add('is-hidden');
          loginBox.classList.remove('is-hidden');
        });
      }

      if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (loginError) loginError.textContent = ''; // Limpiar error previo
          const email = document.getElementById('loginEmail').value;
          const password = document.getElementById('loginPassword').value;
          try {
            showLoading(true);
            await signInWithEmailAndPassword(auth, email, password);
            // onAuthStateChanged se encargará de actualizar la UI y ocultar showLoading
          } catch (error) {
            console.error("Error al iniciar sesión:", error.message);
            if (loginError) loginError.textContent = `Error: ${error.message}`;
            showLoading(false);
          }
        });
      }

      if (registerForm) {
        registerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (registerError) registerError.textContent = ''; // Limpiar error previo
          const name = document.getElementById('registerName').value;
          const email = document.getElementById('registerEmail').value;
          const password = document.getElementById('registerPassword').value;
          try {
            showLoading(true);
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            if (name.trim() !== '') {
              await updateProfile(userCredential.user, { displayName: name.trim() });
              console.log("Perfil actualizado con displayName:", name.trim()); // Para depurar
            } else {
              console.log("No se proveyó nombre, displayName no se actualizó."); // Para depurar
            }
            // onAuthStateChanged se encargará de actualizar la UI y ocultar showLoading
          } catch (error) {
            console.error("Error al registrar:", error.message);
            if (registerError) registerError.textContent = `Error: ${error.message}`;
            showLoading(false);
          }
        });
      }

      if (googleLoginButton) {
        googleLoginButton.addEventListener('click', async () => {
          const provider = new GoogleAuthProvider(); // Crear instancia del proveedor
          try {
            showLoading(true);
            const result = await signInWithPopup(auth, provider); // Llamar a signInWithPopup
            // const user = result.user; // Aquí tienes el usuario de Google
            // onAuthStateChanged se encargará de la UI
          } catch (error) {
            console.error("Error con Google Sign-In:", error);
            if (loginError) loginError.textContent = `Error con Google: ${error.code} - ${error.message}`; // Mostrar más detalles
            if (timerContainer) timerContainer.innerHTML = ''; // Limpiar frases si se queda en authView
            showLoading(false);
          }
        });
      }
      // --- Lógica de la Aplicación Principal (MODIFICADA) ---
      // ELIMINADA la lógica de listeners para audienceTypeRadios, includeLocationCheckbox
      // ELIMINADA la llamada a renderAudienceGroups

      const generateIdeas = httpsCallable(functions, 'generateIdeas');

generateIdeasButton.addEventListener('click', async () => {
        if (!currentUser) {
          showTemporaryMessage(noResultsMessage, "Debes iniciar sesión para generar ideas.");
          return;
        }

        const topic = topicInput.value.trim();
        const copyType = copyTypeSelect.value;

        const selectedSocialNetworks = [];
        document.querySelectorAll('input[name="socialNetwork"]:checked').forEach((checkbox) => {
          selectedSocialNetworks.push(checkbox.value);
        });

        // Validaciones
        if (!topic) {
          showTemporaryMessage(topicInput.parentElement.parentElement, "El tema es obligatorio.", 'is-danger', 3000);
          topicInput.focus();
          return;
        }
        if (selectedSocialNetworks.length === 0) {
          showTemporaryMessage(socialNetworksContainer.parentElement, "Debes seleccionar al menos una red social.", 'is-danger', 3000);
          return;
        }

        // Guardar datos para "cargar última búsqueda"
        lastInputData = {
          topic: topic,
          copyType: copyType,
          socialNetworks: selectedSocialNetworks
        };
        localStorage.setItem('lastInputData', JSON.stringify(lastInputData));

        try {
          const generatedIdeas = await generateIdeas(inputData);

          if (!Array.isArray(generatedIdeas) || generatedIdeas.length === 0) {
            noResultsMessage.classList.remove("is-hidden");
            actionButtonsContainer.classList.remove("is-hidden");
            return;
          }

          renderIdeas(generatedIdeas);
          finalPhraseContainer.classList.remove("is-hidden");
          actionButtonsContainer.classList.remove("is-hidden");

          // Guardar en Firestore
          saveIdeasToFirestore(inputData, generatedIdeas);
        } catch (error) {
          console.error("Error al generar ideas:", error);
          showTemporaryMessage(actionButtonsContainer, "Ocurrió un error al generar ideas. Intenta de nuevo.", 'is-danger', 5000);
          exportPdfButton.innerHTML = originalButtonText;
          exportPdfButton.disabled = false;
        }


        // --- Preparación de UI para Carga ---
        formView.classList.add('is-hidden');
        resultsView.classList.remove('is-hidden');
        ideasResultsArea.innerHTML = '';
        finalPhraseContainer.classList.add('is-hidden');
        actionButtonsContainer.classList.add('is-hidden');
        noResultsMessage.classList.add('is-hidden');

        timerContainer.innerHTML = `<p class="has-text-info animate__animated animate__fadeIn">${loadingPhrases[0]}</p>`;
        actionButtonsContainer.classList.remove('is-hidden');

        timerContainer.innerHTML = ''; // Limpiar

        let currentPhraseIndex = 0;
        timerContainer.innerHTML = `<p class="has-text-info animate__animated animate__fadeIn">${loadingPhrases[currentPhraseIndex]}</p>`;
        phrasesIntervalId = setInterval(() => {
          currentPhraseIndex = (currentPhraseIndex + 1) % loadingPhrases.length;
          const phraseElement = timerContainer.querySelector('p');
          if (phraseElement) {
            phraseElement.classList.remove('animate__fadeIn');
            phraseElement.classList.add('animate__fadeOut');
            
console.log('Exportación lista para usarse cuando se haga clic en el botón PDF.');
          }
        }, 4000);
exportPdfButton.addEventListener('click', () => {
  const originalButtonText = exportPdfButton.innerHTML;
  exportPdfButton.innerHTML = "Generando PDF...";
  exportPdfButton.disabled = true;

  const clone = ideasResultsArea.cloneNode(true);
  clone.style.backgroundColor = "white";
  clone.style.padding = "40px";
  clone.style.width = "100%";
  clone.style.maxWidth = "800px";
  clone.style.margin = "0 auto";

  clone.classList.add("pdf-export-preview");

  document.body.appendChild(clone);

  setTimeout(() => {
    console.log("Exportando PDF desde HTML directamente...");

    html2pdf().from(clone).set({
      margin: 0.5,
      filename: `ideas_generadas_${new Date().toISOString().split("T")[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.95 },
      html2canvas: {
        scale: 2,
        useCORS: true
      },
      jsPDF: {
        unit: 'in',
        format: 'letter',
        orientation: 'portrait'
      },
      pagebreak: {
        mode: ['css', 'legacy'],
        before: '.card'
      }
    }).save().then(() => {
      console.log("✅ PDF generado correctamente.");
    }).catch(err => {
      console.error("❌ Error al generar el PDF:", err);
      showTemporaryMessage(actionButtonsContainer, "Error al generar PDF. Revisa consola.", 'is-danger', 4000);
    }).finally(() => {
      exportPdfButton.innerHTML = originalButtonText;
      exportPdfButton.disabled = false;
      if (clone.parentNode) document.body.removeChild(clone);
    });

  }, 100);
});

});

</script>
</body>

</html>
