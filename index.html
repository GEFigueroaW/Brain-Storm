<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Ideas para Contenido</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6; /* Un fondo suave y cálido */
            color: #363636;
        }

        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-item img {
            max-height: 3.75rem; /* Ajusta según tu logo */
        }

        .button.is-primary {
            background-color: #ff6f61; /* Un color coral cálido y enérgico */
            border-color: transparent;
        }
        .button.is-primary:hover {
            background-color: #e65a50;
        }

        .button.is-success {
            background-color: #79c790; /* Verde suave */
            border-color: transparent;
        }
        .button.is-success:hover {
            background-color: #6ab37f;
        }


        .button.is-link {
            background-color: #5b9bd5; /* Azul profesional */
        }
         .button.is-link:hover {
            background-color: #4a8ac7;
        }

        .title, .subtitle {
            color: #333;
        }

        .hero.is-primary {
            background-color: #ff6f61;
        }
        .hero.is-primary .title, .hero.is-primary .subtitle {
            color: #fff;
        }

        .card {
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        .card-header-title {
            background-color: #f9f9f9;
            color: #333;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: #333;
        }

        /* Estética Coaching */
        .coach-motivation {
            font-style: italic;
            color: #555;
            margin-top: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            text-align: center;
        }

        #ideasResultsArea .card {
            background-color: #fff; /* Fondo blanco para las tarjetas de ideas */
            border-left: 5px solid #ff6f61; /* Acento de color */
        }

        #finalPhraseContainer {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #e6fff3; /* Un fondo suave para la frase final */
            border-radius: 8px;
            text-align: center;
            border: 1px solid #79c790;
        }
        #finalPhraseContainer p {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2b7a78; /* Verde oscuro para el texto */
        }

        /* Responsividad */
        @media screen and (max-width: 768px) {
            .columns.is-desktop {
                flex-direction: column;
            }
        }

        /* Mejoras para la sección de audiencia */
        .audience-group {
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid #dbdbdb;
            border-radius: 4px;
            background-color: #fafafa;
        }
        .audience-group .label {
            font-weight: bold;
        }
        .sub-audience-list label {
            margin-right: 10px;
            display: inline-block; /* Para mejor alineación */
        }
        .max-audience-notice {
            color: red;
            font-size: 0.8em;
        }

        /* Footer */
        .footer {
            background-color: #363636;
            color: #fff;
            padding: 3rem 1.5rem 3rem;
        }
        .footer a {
            color: #ff6f61;
        }
        .footer a:hover {
            color: #e65a50;
        }
        .disclaimer {
            font-size: 0.8rem;
            color: #ccc;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="is-hidden">
        <div class="loader is-loading"></div>
        <p style="margin-left: 10px;">Cargando...</p>
    </div>

    <nav class="navbar" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="#">
                <h1 class="title is-4">Creador de Contenido IA</h1>
            </a>
            <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>
        <div id="navbarBasicExample" class="navbar-menu">
            <div class="navbar-start">
                </div>
            <div class="navbar-end">
                <div class="navbar-item">
                    <div class="buttons">
                        <a id="navLoginButton" class="button is-light">Iniciar Sesión</a>
                        <a id="navRegisterButton" class="button is-primary">Registrarse</a>
                        <a id="navHistoryButton" class="button is-info is-hidden"><i class="fas fa-history mr-2"></i>Historial</a>
                        <a id="navLogoutButton" class="button is-danger is-hidden"><i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <section id="authView" class="section">
        <div class="container">
            <div class="columns is-centered">
                <div class="column is-half">
                    <div id="loginFormContainer">
                        <h2 class="title is-3 has-text-centered">Iniciar Sesión</h2>
                        <div class="box">
                            <div class="field">
                                <label class="label">Email</label>
                                <div class="control has-icons-left">
                                    <input id="loginEmail" class="input" type="email" placeholder="tu@email.com">
                                    <span class="icon is-small is-left"><i class="fas fa-envelope"></i></span>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">Contraseña</label>
                                <div class="control has-icons-left">
                                    <input id="loginPassword" class="input" type="password" placeholder="********">
                                    <span class="icon is-small is-left"><i class="fas fa-lock"></i></span>
                                </div>
                            </div>
                            <div class="field">
                                <button id="loginButton" class="button is-primary is-fullwidth">Iniciar Sesión</button>
                            </div>
                            <hr>
                            <button id="googleLoginButton" class="button is-fullwidth has-background-white has-text-grey-darker" style="border: 1px solid #dbdbdb;">
                                <span class="icon"><i class="fab fa-google"></i></span>
                                <span>Iniciar Sesión con Google</span>
                            </button>
                            <p id="loginError" class="help is-danger has-text-centered mt-2"></p>
                            <p class="has-text-centered mt-3">
                                ¿No tienes cuenta? <a href="#" id="showRegisterLink">Regístrate aquí</a>
                            </p>
                        </div>
                    </div>

                    <div id="registerFormContainer" class="is-hidden">
                        <h2 class="title is-3 has-text-centered">Registrarse</h2>
                        <div class="box">
                            <div class="field">
                                <label class="label">Nombre (Opcional)</label>
                                <div class="control has-icons-left">
                                    <input id="registerName" class="input" type="text" placeholder="Tu Nombre">
                                    <span class="icon is-small is-left"><i class="fas fa-user"></i></span>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">Email</label>
                                <div class="control has-icons-left">
                                    <input id="registerEmail" class="input" type="email" placeholder="tu@email.com" required>
                                    <span class="icon is-small is-left"><i class="fas fa-envelope"></i></span>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">Contraseña</label>
                                <div class="control has-icons-left">
                                    <input id="registerPassword" class="input" type="password" placeholder="********" required>
                                    <span class="icon is-small is-left"><i class="fas fa-lock"></i></span>
                                </div>
                            </div>
                            <div class="field">
                                <button id="registerButton" class="button is-success is-fullwidth">Registrarse</button>
                            </div>
                            <p id="registerError" class="help is-danger has-text-centered mt-2"></p>
                             <p class="has-text-centered mt-3">
                                ¿Ya tienes cuenta? <a href="#" id="showLoginLink">Inicia sesión aquí</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="appView" class="section is-hidden">
        <div class="container">
            <h1 class="title is-2" id="greeting">¡Hola!</h1>
            <p class="subtitle">Vamos a generar ideas increíbles para tu contenido.</p>

            <div class="columns">
                <div class="column is-one-third">
                    <div class="box">
                        <h2 class="title is-4">Parámetros de Generación</h2>
                        <div class="field">
                            <label class="label" for="topicInput">Tema o Palabra Clave Principal</label>
                            <div class="control">
                                <input class="input" type="text" id="topicInput" placeholder="Ej: Marketing Digital para Principiantes">
                            </div>
                            <p class="coach-motivation">✨ ¡Sé nítido como un láser! Cuanto más preciso sea tu tema, más brillantes serán las ideas que desbloquearemos juntos. ✨</p>
                        </div>

                        <div class="field">
                            <label class="label" for="toneSelect">Tono</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="toneSelect">
                                        <option value="Neutral" selected>Neutral</option>
                                        <option value="Formal">Formal</option>
                                        <option value="Informal">Informal</option>
                                        <option value="Alegre/Entusiasta">Alegre/Entusiasta</option>
                                        <option value="Empático">Empático</option>
                                        <option value="Asertivo">Asertivo</option>
                                        <option value="Persuasivo">Persuasivo</option>
                                        <option value="Sarcástico/Irónico">Sarcástico/Irónico</option>
                                        <option value="Motivacional">Motivacional</option>
                                        <option value="Didáctico">Didáctico</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <label class="label">Audiencia Objetivo</label>
                            <div class="control">
                                <label class="radio">
                                    <input type="radio" name="audienceType" value="general" checked>
                                    Público en general
                                </label>
                                <label class="radio">
                                    <input type="radio" name="audienceType" value="target">
                                    Target Específico
                                </label>
                            </div>
                        </div>

                        <div id="targetAudienceSection" class="is-hidden mt-3">
                            <p class="is-size-7 mb-2">Selecciona los grupos y sub-audiencias (máximo 5 sub-audiencias en total): <span id="subAudienceCounter">0/5</span></p>
                            <div id="audienceGroupsContainer">
                                </div>
                            <p id="audienceError" class="help is-danger"></p>
                        </div>


                        <div class="field mt-4">
                            <label class="label" for="maxWordsInput">Máximo de Palabras para el Post (50-500)</label>
                            <div class="control">
                                <input class="input" type="number" id="maxWordsInput" value="100" min="50" max="500">
                            </div>
                        </div>

                        <div class="field mt-4">
                            <label class="checkbox">
                                <input type="checkbox" id="includeLocationCheckbox">
                                Incluir sugerencia de ubicación (Geotagging)
                            </label>
                        </div>
                        <div id="locationInputContainer" class="field is-hidden">
                            <label class="label" for="locationInput">Ubicación deseada para la sugerencia</label>
                            <div class="control">
                                <input class="input" type="text" id="locationInput" placeholder="Ej: 'Ciudad de México', 'Parque Central', 'Online'">
                            </div>
                        </div>

                        <div class="field mt-5">
                            <button id="generateIdeasButton" class="button is-primary is-fullwidth is-large animate__animated animate__pulse animate__infinite">
                                <span class="icon"><i class="fas fa-lightbulb"></i></span>
                                <span>✨ ¡Generar 5 Ideas! ✨</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="column">
                     <div id="actionButtonsContainer" class="mb-4 is-hidden has-text-right">
                        <button id="refreshIdeasButton" class="button is-link mr-2">
                            <span class="icon"><i class="fas fa-sync-alt"></i></span>
                            <span>Refrescar Inspiraciones</span>
                        </button>
                        <button id="exportPdfButton" class="button is-success mr-2">
                            <span class="icon"><i class="fas fa-file-pdf"></i></span>
                            <span>Exportar a PDF</span>
                        </button>
                        <button id="exportCsvButton" class="button is-info">
                            <span class="icon"><i class="fas fa-file-csv"></i></span>
                            <span>Exportar a CSV</span>
                        </button>
                    </div>
                    <div id="ideasResultsArea">
                        <p id="noResultsMessage" class="has-text-centered has-text-grey">Aún no se han generado ideas. ¡Completa los campos y haz clic en generar!</p>
                    </div>
                    <div id="finalPhraseContainer" class="is-hidden">
                        <p id="finalPhraseText"></p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="historyModal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card" style="width: 80%; max-width: 800px;">
            <header class="modal-card-head">
                <p class="modal-card-title">Historial de Generaciones (Últimas 50)</p>
                <button class="delete" aria-label="close" id="closeHistoryModal"></button>
            </header>
            <section class="modal-card-body">
                <div id="historyListContainer">
                    <p>Cargando historial...</p>
                </div>
                <p id="historyError" class="help is-danger"></p>
            </section>
            <footer class="modal-card-foot">
                <button id="loadHistoryDetailsButton" class="button is-success" disabled>Cargar Detalles para Exportar</button>
                <button id="cancelHistoryModal" class="button">Cancelar</button>
            </footer>
        </div>
    </div>

    <footer class="footer">
        <div class="content has-text-centered">
            <p>
                <strong>Generador de Ideas para Contenido IA</strong> por TuNombre/TuEmpresa.
            </p>
            <p class="disclaimer">
                Descargo de responsabilidad: El contenido generado por esta aplicación es producido por una Inteligencia Artificial (IA) y se basa en tendencias y conocimientos disponibles para dicha IA hasta su última actualización. El usuario es el único responsable de verificar, validar y asegurar la originalidad, precisión, legalidad y adecuación de cualquier contenido generado, incluyendo, pero no limitándose a, textos, hashtags, sugerencias de formato visual y sugerencias de ubicación. El uso de marcas registradas, nombres propios o cualquier material protegido por derechos de autor debe hacerse de acuerdo con las leyes aplicables. No nos hacemos responsables por el uso indebido o las consecuencias derivadas del uso del contenido generado.
            </p>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>

    <script>
        // Configuración de Firebase (reemplaza con tus datos)
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();
        // Si estás en un entorno de desarrollo local para Functions:
        // functions.useEmulator("localhost", 5001);


        // Variables globales
        let currentUser = null;
        let currentViewingSessionId = null; // Para saber qué sesión se está mostrando (nueva o del historial)
        const MAX_SUB_AUDIENCES = 5;
        let selectedSubAudiencesCount = 0;

        // Selectores de Elementos del DOM
        const loadingOverlay = document.getElementById('loadingOverlay');
        const authView = document.getElementById('authView');
        const appView = document.getElementById('appView');
        const greeting = document.getElementById('greeting');

        // Navbar
        const navLoginButton = document.getElementById('navLoginButton');
        const navRegisterButton = document.getElementById('navRegisterButton');
        const navHistoryButton = document.getElementById('navHistoryButton');
        const navLogoutButton = document.getElementById('navLogoutButton');

        // Forms Auth
        const loginFormContainer = document.getElementById('loginFormContainer');
        const registerFormContainer = document.getElementById('registerFormContainer');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginButton = document.getElementById('loginButton');
        const googleLoginButton = document.getElementById('googleLoginButton');
        const loginError = document.getElementById('loginError');
        const showRegisterLink = document.getElementById('showRegisterLink');

        const registerNameInput = document.getElementById('registerName');
        const registerEmailInput = document.getElementById('registerEmail');
        const registerPasswordInput = document.getElementById('registerPassword');
        const registerButton = document.getElementById('registerButton');
        const registerError = document.getElementById('registerError');
        const showLoginLink = document.getElementById('showLoginLink');

        // App View Inputs
        const topicInput = document.getElementById('topicInput');
        const toneSelect = document.getElementById('toneSelect');
        const audienceTypeRadios = document.querySelectorAll('input[name="audienceType"]');
        const targetAudienceSection = document.getElementById('targetAudienceSection');
        const audienceGroupsContainer = document.getElementById('audienceGroupsContainer');
        const subAudienceCounter = document.getElementById('subAudienceCounter');
        const audienceError = document.getElementById('audienceError');
        const maxWordsInput = document.getElementById('maxWordsInput');
        const includeLocationCheckbox = document.getElementById('includeLocationCheckbox');
        const locationInputContainer = document.getElementById('locationInputContainer');
        const locationInput = document.getElementById('locationInput');
        const generateIdeasButton = document.getElementById('generateIdeasButton');

        // App View Outputs
        const ideasResultsArea = document.getElementById('ideasResultsArea');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const finalPhraseContainer = document.getElementById('finalPhraseContainer');
        const finalPhraseText = document.getElementById('finalPhraseText');
        const actionButtonsContainer = document.getElementById('actionButtonsContainer');
        const refreshIdeasButton = document.getElementById('refreshIdeasButton');
        const exportPdfButton = document.getElementById('exportPdfButton');
        const exportCsvButton = document.getElementById('exportCsvButton');

        // Historial Modal
        const historyModal = document.getElementById('historyModal');
        const closeHistoryModal = document.getElementById('closeHistoryModal');
        const cancelHistoryModal = document.getElementById('cancelHistoryModal');
        const historyListContainer = document.getElementById('historyListContainer');
        const loadHistoryDetailsButton = document.getElementById('loadHistoryDetailsButton');
        const historyError = document.getElementById('historyError');
        let selectedHistoryEntryId = null;


        // --- ESTRUCTURA DE AUDIENCIAS ---
        const audienceData = {
            "Profesionales y Emprendedores": ["Emprendedores", "Profesionales jóvenes", "Freelancers/independientes", "Inversionistas/financieros", "Pequeños empresarios", "Trabajadores remotos"],
            "Comunidades por Intereses o Pasatiempos": ["Amantes de la tecnología", "Aficionados al deporte", "Gamers", "Gourmets/amantes de la gastronomía", "Artistas y diseñadores", "Coleccionistas"],
            "Grupos por Etapa de Vida o Rol Familiar": ["Estudiantes universitarios", "Padres de familia", "Adultos mayores", "Nuevos padres/madres", "Personas en reinvención profesional"],
            "Audiencias con Estilos de Vida Específicos": ["Ecológicos/ambientalistas", "Viajeros frecuentes", "Amantes del lujo", "Personas enfocadas en salud y bienestar", "Comunidad LGBTQ+", "Influencers/content creators"],
            "Personas en Contextos o Necesidades Particulares": ["Personas con discapacidades", "Desempleados", "Activistas", "Comunidades rurales"]
        };

        function renderAudienceGroups() {
            audienceGroupsContainer.innerHTML = '';
            for (const groupName in audienceData) {
                const groupDiv = document.createElement('div');
                groupDiv.classList.add('audience-group');

                const groupLabel = document.createElement('label');
                groupLabel.classList.add('label', 'checkbox');
                const groupCheckbox = document.createElement('input');
                groupCheckbox.type = 'checkbox';
                groupCheckbox.dataset.groupName = groupName;
                groupCheckbox.classList.add('mr-2');
                groupLabel.appendChild(groupCheckbox);
                groupLabel.appendChild(document.createTextNode(groupName));
                groupDiv.appendChild(groupLabel);

                const subAudienceListDiv = document.createElement('div');
                subAudienceListDiv.classList.add('sub-audience-list', 'ml-4', 'mt-2', 'is-hidden');

                audienceData[groupName].forEach(subAudience => {
                    const subAudienceLabel = document.createElement('label');
                    subAudienceLabel.classList.add('checkbox', 'mr-3');
                    const subAudienceCheckbox = document.createElement('input');
                    subAudienceCheckbox.type = 'checkbox';
                    subAudienceCheckbox.value = subAudience;
                    subAudienceCheckbox.name = 'subAudience';
                    subAudienceCheckbox.classList.add('mr-1');
                    subAudienceLabel.appendChild(subAudienceCheckbox);
                    subAudienceLabel.appendChild(document.createTextNode(subAudience));
                    subAudienceListDiv.appendChild(subAudienceLabel);

                    subAudienceCheckbox.addEventListener('change', () => {
                        if (subAudienceCheckbox.checked) {
                            if (selectedSubAudiencesCount < MAX_SUB_AUDIENCES) {
                                selectedSubAudiencesCount++;
                            } else {
                                subAudienceCheckbox.checked = false; // No permitir seleccionar más
                                // Opcional: mostrar un mensaje
                                showTemporaryMessage(audienceError, "No puedes seleccionar más de 5 sub-audiencias.", "is-warning");
                            }
                        } else {
                            selectedSubAudiencesCount--;
                        }
                        updateSubAudienceCounter();
                        validateAudienceSelection();
                    });
                });

                groupDiv.appendChild(subAudienceListDiv);
                audienceGroupsContainer.appendChild(groupDiv);

                groupCheckbox.addEventListener('change', () => {
                    if (groupCheckbox.checked) {
                        subAudienceListDiv.classList.remove('is-hidden');
                    } else {
                        subAudienceListDiv.classList.add('is-hidden');
                        // Desmarcar sub-audiencias de este grupo si el grupo se desactiva
                        subAudienceListDiv.querySelectorAll('input[type="checkbox"]:checked').forEach(chk => {
                            chk.checked = false;
                            selectedSubAudiencesCount--;
                        });
                        updateSubAudienceCounter();
                    }
                    validateAudienceSelection();
                });
            }
            updateSubAudienceCounter();
        }

        function updateSubAudienceCounter() {
            subAudienceCounter.textContent = `${selectedSubAudiencesCount}/${MAX_SUB_AUDIENCES}`;
            if (selectedSubAudiencesCount >= MAX_SUB_AUDIENCES) {
                audienceGroupsContainer.querySelectorAll('input[name="subAudience"]:not(:checked)').forEach(chk => chk.disabled = true);
                subAudienceCounter.classList.add('max-audience-notice');

            } else {
                audienceGroupsContainer.querySelectorAll('input[name="subAudience"]:not(:checked)').forEach(chk => chk.disabled = false);
                subAudienceCounter.classList.remove('max-audience-notice');
            }
        }

        function getSelectedAudienceDetails() {
            const selected = [];
            audienceGroupsContainer.querySelectorAll('input[name="subAudience"]:checked').forEach(chk => {
                selected.push(chk.value);
            });
            // Incluir nombres de grupos activados si no hay sub-audiencias seleccionadas de ese grupo
            audienceGroupsContainer.querySelectorAll('input[data-group-name]:checked').forEach(groupChk => {
                const groupName = groupChk.dataset.groupName;
                const hasSelectedSub = Array.from(audienceGroupsContainer.querySelectorAll(`input[name="subAudience"][value^="${groupName.substring(0,5)}"]:checked`)).length > 0; // Simplistic check

                let groupHasSelectedSub = false;
                audienceData[groupName].forEach(sub => {
                    if(selected.includes(sub)) groupHasSelectedSub = true;
                });

                if (!groupHasSelectedSub && !selected.includes(groupName)) { // Evitar duplicar si ya está por sub-audiencia
                     // selected.push(groupName); // Se podría agregar el nombre del grupo si es necesario
                }
            });
            return selected;
        }

        function validateAudienceSelection() {
            const audienceType = document.querySelector('input[name="audienceType"]:checked').value;
            audienceError.textContent = '';
            if (audienceType === 'target') {
                const selectedGroups = audienceGroupsContainer.querySelectorAll('input[data-group-name]:checked').length;
                const selectedSubs = getSelectedAudienceDetails().length;
                if (selectedGroups === 0 && selectedSubs === 0) {
                    audienceError.textContent = 'Si seleccionas "Target Específico", debes activar al menos un grupo O seleccionar al menos una sub-audiencia.';
                    return false;
                }
                 if (selectedSubs > MAX_SUB_AUDIENCES) {
                    audienceError.textContent = `Has seleccionado ${selectedSubs} sub-audiencias. El máximo es ${MAX_SUB_AUDIENCES}.`;
                    return false;
                }
            }
            return true;
        }


        // --- Funciones Auxiliares ---
        function showLoading(show) {
            loadingOverlay.classList.toggle('is-hidden', !show);
        }

        function showTemporaryMessage(element, message, bulmaClass = 'is-danger', duration = 4000) {
            element.textContent = message;
            element.classList.remove('is-danger', 'is-success', 'is-warning', 'is-info'); // Limpiar clases previas
            element.classList.add(bulmaClass);
            element.classList.remove('is-hidden');
            setTimeout(() => {
                element.textContent = '';
                element.classList.add('is-hidden');
            }, duration);
        }

        function updateUIForAuthState(user) {
            currentUser = user;
            if (user) {
                authView.classList.add('is-hidden');
                appView.classList.remove('is-hidden');
                greeting.textContent = `¡Hola, ${user.displayName || user.email}!`;

                navLoginButton.classList.add('is-hidden');
                navRegisterButton.classList.add('is-hidden');
                navHistoryButton.classList.remove('is-hidden');
                navLogoutButton.classList.remove('is-hidden');

                // Resetear campos por si acaso
                clearGenerationForm();
                clearResultsArea();
                currentViewingSessionId = null; // Nueva sesión al loguear
            } else {
                authView.classList.remove('is-hidden');
                appView.classList.add('is-hidden');
                greeting.textContent = '¡Hola!';

                navLoginButton.classList.remove('is-hidden');
                navRegisterButton.classList.remove('is-hidden');
                navHistoryButton.classList.add('is-hidden');
                navLogoutButton.classList.add('is-hidden');

                loginError.textContent = '';
                registerError.textContent = '';
                currentViewingSessionId = null;
            }
        }

        function clearGenerationForm() {
            topicInput.value = '';
            toneSelect.value = 'Neutral';
            document.querySelector('input[name="audienceType"][value="general"]').checked = true;
            targetAudienceSection.classList.add('is-hidden');
            renderAudienceGroups(); // Resetea la selección de audiencias
            selectedSubAudiencesCount = 0;
            updateSubAudienceCounter();
            maxWordsInput.value = 100;
            includeLocationCheckbox.checked = false;
            locationInputContainer.classList.add('is-hidden');
            locationInput.value = '';
            audienceError.textContent = '';
        }

        function clearResultsArea() {
            ideasResultsArea.innerHTML = '';
            ideasResultsArea.appendChild(noResultsMessage); // Mostrar mensaje inicial
            noResultsMessage.classList.remove('is-hidden');
            finalPhraseContainer.classList.add('is-hidden');
            finalPhraseText.textContent = '';
            actionButtonsContainer.classList.add('is-hidden');
        }


        // --- Lógica de Autenticación ---
        auth.onAuthStateChanged(updateUIForAuthState);

        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginFormContainer.classList.add('is-hidden');
            registerFormContainer.classList.remove('is-hidden');
            loginError.textContent = '';
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerFormContainer.classList.add('is-hidden');
            loginFormContainer.classList.remove('is-hidden');
            registerError.textContent = '';
        });

        loginButton.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            loginError.textContent = '';
            showLoading(true);
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                // Actualizar lastLoginAt
                await db.collection('users').doc(userCredential.user.uid).set({
                    lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                // UI se actualiza con onAuthStateChanged
            } catch (error) {
                console.error("Error en login:", error);
                loginError.textContent = "Error al iniciar sesión: " + error.message;
            } finally {
                showLoading(false);
            }
        });

        registerButton.addEventListener('click', async () => {
            const name = registerNameInput.value;
            const email = registerEmailInput.value;
            const password = registerPasswordInput.value;
            registerError.textContent = '';

            if (!email || !password) {
                registerError.textContent = "Email y contraseña son obligatorios.";
                return;
            }
            showLoading(true);
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                await user.updateProfile({ displayName: name });

                // Guardar usuario en Firestore
                await db.collection('users').doc(user.uid).set({
                    email: user.email,
                    name: name || user.displayName, // Usar el nombre proporcionado o el del perfil
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                // UI se actualiza con onAuthStateChanged
            } catch (error) {
                console.error("Error en registro:", error);
                registerError.textContent = "Error al registrarse: " + error.message;
            } finally {
                showLoading(false);
            }
        });

        googleLoginButton.addEventListener('click', async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            loginError.textContent = '';
            showLoading(true);
            try {
                const result = await auth.signInWithPopup(provider);
                const user = result.user;

                // Guardar/actualizar usuario en Firestore
                const userRef = db.collection('users').doc(user.uid);
                const userDoc = await userRef.get();
                if (!userDoc.exists) {
                    await userRef.set({
                        email: user.email,
                        name: user.displayName,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    await userRef.update({
                        lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
                        name: user.displayName // Actualizar nombre por si cambia en Google
                    });
                }
                // UI se actualiza con onAuthStateChanged
            } catch (error) {
                console.error("Error con Google login:", error);
                loginError.textContent = "Error con Google: " + error.message;
            } finally {
                showLoading(false);
            }
        });

        navLogoutButton.addEventListener('click', async () => {
            showLoading(true);
            try {
                await auth.signOut();
                // UI se actualiza con onAuthStateChanged
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                // Manejar error si es necesario
            } finally {
                showLoading(false);
            }
        });


        // --- Lógica de la Aplicación Principal ---
        audienceTypeRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                if (event.target.value === 'target') {
                    targetAudienceSection.classList.remove('is-hidden');
                    validateAudienceSelection(); // Validar al mostrar
                } else {
                    targetAudienceSection.classList.add('is-hidden');
                    audienceError.textContent = ''; // Limpiar error si se cambia a general
                }
            });
        });

        renderAudienceGroups(); // Cargar grupos de audiencia al inicio

        includeLocationCheckbox.addEventListener('change', () => {
            locationInputContainer.classList.toggle('is-hidden', !includeLocationCheckbox.checked);
            if (!includeLocationCheckbox.checked) {
                locationInput.value = ''; // Limpiar si se desmarca
            }
        });

        generateIdeasButton.addEventListener('click', async () => {
            if (!currentUser) {
                showTemporaryMessage(ideasResultsArea.querySelector('#noResultsMessage') || ideasResultsArea, "Debes iniciar sesión para generar ideas.");
                return;
            }

            const topic = topicInput.value.trim();
            const tone = toneSelect.value;
            const audienceType = document.querySelector('input[name="audienceType"]:checked').value;
            let audienceDetails = [];
            const maxWords = parseInt(maxWordsInput.value, 10);
            const includeLocation = includeLocationCheckbox.checked;
            const locationText = locationInput.value.trim();

            if (!topic) {
                showTemporaryMessage(topicInput.nextElementSibling, "El tema es obligatorio.", 'is-danger', 3000);
                topicInput.focus();
                return;
            }
            if (isNaN(maxWords) || maxWords < 50 || maxWords > 500) {
                 showTemporaryMessage(maxWordsInput.parentElement.nextElementSibling || maxWordsInput.parentElement, "Máximo de palabras debe ser entre 50 y 500.", 'is-danger', 3000);
                maxWordsInput.focus();
                return;
            }
             if (includeLocation && !locationText) {
                showTemporaryMessage(locationInput.nextElementSibling || locationInput.parentElement , "Debes especificar una ubicación si la casilla está marcada.", 'is-danger', 3000);
                locationInput.focus();
                return;
            }


            if (audienceType === 'target') {
                if (!validateAudienceSelection()){
                    return; // Detener si la validación de audiencia falla
                }
                audienceDetails = getSelectedAudienceDetails();
            }


            showLoading(true);
            ideasResultsArea.innerHTML = '<p class="has-text-centered">✨ Generando ideas...</p>'; // Mensaje mientras carga
            finalPhraseContainer.classList.add('is-hidden');
            actionButtonsContainer.classList.add('is-hidden');


            try {
                const generateIdeasFunction = functions.httpsCallable('generateIdeas');
                const result = await generateIdeasFunction({
                    topic: topic,
                    tone: tone,
                    audienceType: audienceType,
                    audienceDetails: audienceDetails,
                    maxWords: maxWords,
                    includeLocation: includeLocation,
                    locationInput: locationText
                });

                if (result.data && result.data.success) {
                    currentViewingSessionId = result.data.sessionId; // Guardar ID de la sesión actual
                    displayGeneratedIdeas(result.data.ideas);
                    displayFinalPhrase(result.data.finalPhrase);
                    actionButtonsContainer.classList.remove('is-hidden');
                    noResultsMessage.classList.add('is-hidden');
                } else {
                    throw new Error(result.data.error || "No se pudieron generar las ideas.");
                }
            } catch (error) {
                console.error("Error al generar ideas:", error);
                ideasResultsArea.innerHTML = `<div class="notification is-danger">Error al generar ideas: ${error.message}</div>`;
            } finally {
                showLoading(false);
            }
        });

        function displayGeneratedIdeas(ideas) {
            ideasResultsArea.innerHTML = ''; // Limpiar área
            if (!ideas || ideas.length === 0) {
                ideasResultsArea.innerHTML = '<p class="has-text-centered">No se generaron ideas. Intenta ajustar tus parámetros.</p>';
                return;
            }

            ideas.forEach((idea, index) => {
                const card = document.createElement('div');
                card.classList.add('card', 'animate__animated', 'animate__fadeInUp');
                card.style.animationDelay = `${index * 0.1}s`;

                const header = document.createElement('header');
                header.classList.add('card-header');
                const title = document.createElement('p');
                title.classList.add('card-header-title');
                title.textContent = `Idea ${index + 1}`;
                header.appendChild(title);
                card.appendChild(header);

                const content = document.createElement('div');
                content.classList.add('card-content');

                content.innerHTML = `
                    <div class="content">
                        <p><strong>Texto o Copy:</strong></p>
                        <p>${idea.textoCopy || 'N/A'}</p>
                        <p><strong>Hashtags:</strong> ${Array.isArray(idea.hashtags) ? idea.hashtags.join(', ') : (idea.hashtags || 'N/A')}</p>
                        <p><strong>Formato Visual Sugerido:</strong> ${idea.formatoVisual || 'N/A'}</p>
                        <p><strong>Gancho Verbal Impactante:</strong> ${idea.ganchoVerbal || 'N/A'}</p>
                        ${(idea.sugerenciaUbicacion && idea.sugerenciaUbicacion !== "N/A") ? `<p><strong>Sugerencia de Ubicación:</strong> ${idea.sugerenciaUbicacion}</p>` : ''}
                    </div>
                `;
                card.appendChild(content);
                ideasResultsArea.appendChild(card);
            });
        }

        function displayFinalPhrase(phrase) {
            if (phrase) {
                finalPhraseText.textContent = phrase;
                finalPhraseContainer.classList.remove('is-hidden');
                finalPhraseContainer.classList.add('animate__animated', 'animate__fadeIn');
            } else {
                finalPhraseContainer.classList.add('is-hidden');
            }
        }

        refreshIdeasButton.addEventListener('click', () => {
            // Simplemente vuelve a llamar a generateIdeasButton. La lógica de obtener los valores ya está ahí.
            // Asegurarse que los inputs no se borren si el usuario solo quiere refrescar.
            if (currentViewingSessionId) { // Solo si hay algo que "refrescar" basado en los mismos inputs
                 generateIdeasButton.click();
            } else {
                showTemporaryMessage(ideasResultsArea.firstChild || ideasResultsArea, "Primero genera un conjunto de ideas para poder refrescarlas.", "is-info");
            }
        });


        // --- Lógica de Historial ---
        navHistoryButton.addEventListener('click', async () => {
            if (!currentUser) return;
            historyModal.classList.add('is-active');
            historyListContainer.innerHTML = '<p>Cargando historial...</p>';
            historyError.textContent = '';
            loadHistoryDetailsButton.disabled = true;
            selectedHistoryEntryId = null;

            try {
                const getHistorySummaryFunction = functions.httpsCallable('getHistorySummary');
                const result = await getHistorySummaryFunction();

                if (result.data && result.data.success) {
                    renderHistoryList(result.data.history);
                } else {
                    throw new Error(result.data.error || "No se pudo cargar el historial.");
                }
            } catch (error) {
                console.error("Error al cargar historial:", error);
                historyListContainer.innerHTML = `<div class="notification is-danger">Error al cargar el historial: ${error.message}</div>`;
            }
        });

        function renderHistoryList(historyItems) {
            historyListContainer.innerHTML = '';
            if (!historyItems || historyItems.length === 0) {
                historyListContainer.innerHTML = '<p class="has-text-centered">No tienes generaciones guardadas en tu historial.</p>';
                return;
            }

            const list = document.createElement('div');
            list.classList.add('list', 'is-hoverable');

            historyItems.forEach(item => {
                const listItem = document.createElement('a');
                listItem.classList.add('list-item');
                listItem.dataset.sessionId = item.id;

                const timestamp = item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleString('es-ES') : 'Fecha desconocida';
                let audienceText = item.audienceType === 'general' ? 'Público en general' : (item.audienceDetails && item.audienceDetails.length > 0 ? item.audienceDetails.join(', ') : 'Target específico (sin detalles)');
                if (audienceText.length > 50) audienceText = audienceText.substring(0, 47) + "..."; // Acortar

                listItem.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title"><strong>Tema:</strong> ${item.topic || 'N/A'}</div>
                        <div class="list-item-description">
                            <small><strong>Fecha:</strong> ${timestamp}</small><br>
                            <small><strong>Tono:</strong> ${item.tone || 'N/A'}</small><br>
                            <small><strong>Audiencia:</strong> ${audienceText}</small>
                            ${item.locationInput ? `<br><small><strong>Ubicación:</strong> ${item.locationInput}</small>` : ''}
                        </div>
                    </div>
                `;

                listItem.addEventListener('click', () => {
                    // Desmarcar previamente seleccionado
                    const currentlySelected = list.querySelector('.is-active');
                    if (currentlySelected) {
                        currentlySelected.classList.remove('is-active');
                    }
                    // Marcar nuevo
                    listItem.classList.add('is-active');
                    selectedHistoryEntryId = item.id;
                    loadHistoryDetailsButton.disabled = false;
                });
                list.appendChild(listItem);
            });
            historyListContainer.appendChild(list);
        }

        closeHistoryModal.addEventListener('click', () => historyModal.classList.remove('is-active'));
        cancelHistoryModal.addEventListener('click', () => historyModal.classList.remove('is-active'));

        loadHistoryDetailsButton.addEventListener('click', async () => {
            if (!selectedHistoryEntryId || !currentUser) return;

            showLoading(true);
            historyModal.classList.remove('is-active'); // Cerrar modal
            ideasResultsArea.innerHTML = '<p class="has-text-centered">✨ Cargando detalles del historial...</p>';
            finalPhraseContainer.classList.add('is-hidden');
            actionButtonsContainer.classList.add('is-hidden');


            try {
                const getGenerationDetailsFunction = functions.httpsCallable('getGenerationDetails');
                const result = await getGenerationDetailsFunction({ sessionId: selectedHistoryEntryId });

                if (result.data && result.data.success) {
                    const sessionData = result.data.session;
                    currentViewingSessionId = sessionData.id; // ID del documento de Firestore es el sessionId
                    displayGeneratedIdeas(sessionData.ideas);
                    displayFinalPhrase(sessionData.finalPhrase);
                    actionButtonsContainer.classList.remove('is-hidden');
                    noResultsMessage.classList.add('is-hidden');

                    // Opcional: rellenar los inputs con los datos de la sesión cargada
                    topicInput.value = sessionData.topic || '';
                    toneSelect.value = sessionData.tone || 'Neutral';
                    // ...y así sucesivamente para otros campos si se desea.
                    // Esto es más complejo para la audiencia, requeriría lógica adicional.

                } else {
                    throw new Error(result.data.error || "No se pudieron cargar los detalles de la sesión.");
                }

            } catch (error) {
                console.error("Error al cargar detalles de sesión:", error);
                ideasResultsArea.innerHTML = `<div class="notification is-danger">Error al cargar detalles: ${error.message}</div>`;
            } finally {
                showLoading(false);
            }
        });


        // --- Lógica de Exportación ---
        exportPdfButton.addEventListener('click', () => {
            if (!ideasResultsArea.querySelector('.card')) { // Si no hay 'cards' de ideas
                showTemporaryMessage(actionButtonsContainer.querySelector('.is-danger') || actionButtonsContainer, "No hay contenido para exportar a PDF.", 'is-warning');
                return;
            }
            showLoading(true);
            const element = ideasResultsArea; // Exportar solo el área de resultados
            const timestamp = new Date().toISOString().slice(0,10); // YYYY-MM-DD

            // Clonar el elemento para no modificar el original directamente
            const elementToExport = element.cloneNode(true);
            // Opcional: remover elementos no deseados del clon antes de exportar
            // elementToExport.querySelectorAll('.acciones-idea-no-exportar').forEach(el => el.remove());

            html2pdf().from(elementToExport).set({
                margin: [15, 10, 15, 10], // arriba, derecha, abajo, izquierda en mm
                filename: `Inspiraciones-${timestamp}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, useCORS: true }, // useCORS si hay imágenes externas
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).save().then(() => {
                showLoading(false);
            }).catch(err => {
                showLoading(false);
                console.error("Error al generar PDF:", err);
                showTemporaryMessage(actionButtonsContainer, "Error al generar PDF.", 'is-danger');
            });
        });

        exportCsvButton.addEventListener('click', async () => {
            if (!currentViewingSessionId) {
                 showTemporaryMessage(actionButtonsContainer.querySelector('.is-danger') || actionButtonsContainer, "No hay una sesión activa para exportar a CSV. Genera ideas o carga desde el historial.", 'is-warning');
                return;
            }
            showLoading(true);
            try {
                const exportCsvFunction = functions.httpsCallable('exportCsv');
                const result = await exportCsvFunction({ sessionId: currentViewingSessionId });

                if (result.data && result.data.success) {
                    const csvString = result.data.csv;
                    const timestamp = new Date().toISOString().slice(0,10);
                    const filename = `Inspiraciones-${timestamp}.csv`;

                    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    if (link.download !== undefined) { // Feature detection
                        const url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", filename);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } else {
                        alert("Tu navegador no soporta la descarga directa. El CSV se mostrará en una nueva pestaña si es posible.");
                        // Fallback para navegadores antiguos (puede no funcionar bien)
                        window.open('data:text/csv;charset=utf-8,' + encodeURIComponent(csvString));
                    }
                } else {
                    throw new Error(result.data.error || "No se pudo generar el CSV.");
                }

            } catch (error) {
                console.error("Error al exportar CSV:", error);
                showTemporaryMessage(actionButtonsContainer.querySelector('.is-danger') || actionButtonsContainer, `Error al exportar CSV: ${error.message}`, 'is-danger');
            } finally {
                showLoading(false);
            }
        });


        // --- Inicialización y Listeners Adicionales ---
        // Burger menu para móviles
        const burger = document.querySelector('.navbar-burger');
        const menu = document.querySelector('.navbar-menu');
        if (burger && menu) {
            burger.addEventListener('click', () => {
                burger.classList.toggle('is-active');
                menu.classList.toggle('is-active');
            });
        }

        // Mensaje de bienvenida o carga inicial
        console.log("Aplicación de generación de ideas inicializada.");

    </script>
</body>
</html>
