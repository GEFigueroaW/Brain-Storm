<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description"
    content="Genera ideas impactantes para redes sociales con IA. Usa FeedFlow, una app creativa, profesional y visualmente atractiva." />
  <title>FeedFlow ‚Äì Ideas con IA</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <!-- CSS LIBRARIES -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root {
      --ff-morado: #8e44ad;
      --ff-dorado: #f1c40f;
      --ff-fondo: #fdfdfd;
      --ff-degradado: linear-gradient(to right, #8e44ad, #f39c12);
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--ff-fondo);
      color: #333;
    }

    .ff-logo {
      font-size: 2rem;
      font-weight: bold;
      color: var(--ff-morado);
    }

    .ff-gradient {
      background: var(--ff-degradado);
      color: white;
    }

    .ff-section {
      padding: 2rem 1rem;
    }

    .is-hidden {
      display: none !important;
    }
    .card {
      border: 1px solid #ececec;
      border-radius: .5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      margin-bottom: 1rem;
    }
    .ff-feedback-btn {
      margin-left: .5em;
    }
    .modal.is-active {
      display: flex;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.3);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #fff;
      border-radius: .5em;
      padding: 2em;
      max-width: 400px;
      margin: auto;
    }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <section id="ff-auth-view" class="ff-section">
    <div class="container">
      <h1 class="title has-text-centered ff-logo">FeedFlow</h1>
      <p class="subtitle has-text-centered" id="auth-title">Inicia sesi√≥n para comenzar</p>
      <div class="box has-background-light mt-4">
        <label class="label" id="ff-label-language-app">Idioma de la aplicaci√≥n</label>
        <div class="control">
          <div class="select is-fullwidth">
            <select id="ff-auth-language-selector"
              title="Elige el idioma para la interfaz y las ideas generadas. / Select the language for the interface and generated ideas. / Escolha o idioma da interface e das ideias geradas.">
              <option value="es">Espa√±ol</option>
              <option value="en">English</option>
              <option value="pt">Portugu√™s</option>
            </select>
          </div>
        </div>
        <p class="help mt-1">
          <em>Elige el idioma para la interfaz y las ideas generadas.</em><br>
          <em>Select the language for the interface and generated ideas.</em><br>
          <em>Escolha o idioma da interface e das ideias geradas.</em>
        </p>
      </div>
      <div class="buttons is-centered">
        <button id="ff-google-login" class="button is-light">
          <span class="icon"><i class="fab fa-google"></i></span>
          <span>Google</span>
        </button>
        <div id="ff-loading" class="notification is-warning is-light is-hidden animate__animated animate__fadeIn">
          <strong>Generando ideas...</strong> Por favor, espera un momento.
        </div>
      </div>
      <p id="toggle-auth-text" class="has-text-centered mt-4"></p>
    </div>
  </section>

  <!-- MODAL FEEDBACK -->
  <div class="modal" id="ff-feedback-modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <h3 class="title is-5">¬°Gracias por tu feedback!</h3>
      <p>Tu opini√≥n ayuda a mejorar la calidad de las ideas generadas.</p>
      <button id="ff-close-feedback" class="button is-primary mt-3">Cerrar</button>
    </div>
  </div>

  <!-- VISTA PRINCIPAL (AUTENTICADO) -->
  <section id="ff-config-view" class="ff-section is-hidden">
    <div class="container">
      <h2 class="title is-4" id="title-results">Genera ideas con IA</h2>
      <!-- FORMULARIO DE GENERACI√ìN -->
      <div class="box">
        <div class="field">
          <label class="label" for="ff-keyword">Palabra clave</label>
          <div class="control">
            <input class="input" type="text" id="ff-keyword" placeholder="Ej: marketing digital, recetas f√°ciles, fitness">
          </div>
        </div>
        <div class="field">
          <label class="label" for="ff-copytype">Tipo de copy</label>
          <div class="control">
            <div class="select is-fullwidth">
              <select id="ff-copytype">
                <option value="post">Post</option>
                <option value="story">Story</option>
                <option value="tweet">Tweet</option>
                <option value="idea">Idea Creativa</option>
              </select>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="label" for="ff-mode-selector">Modo</label>
          <div class="control">
            <div class="select is-fullwidth">
              <select id="ff-mode-selector">
                <option value="individual">Individual</option>
                <option value="multiple">M√∫ltiple</option>
              </select>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="label">Redes sociales</label>
          <div id="ff-networks-container" class="buttons">
            <label class="button is-small">
              <input type="checkbox" class="ff-social" value="instagram"> Instagram
            </label>
            <label class="button is-small">
              <input type="checkbox" class="ff-social" value="facebook"> Facebook
            </label>
            <label class="button is-small">
              <input type="checkbox" class="ff-social" value="twitter"> Twitter/X
            </label>
            <label class="button is-small">
              <input type="checkbox" class="ff-social" value="tiktok"> TikTok
            </label>
            <label class="button is-small">
              <input type="checkbox" class="ff-social" value="linkedin"> LinkedIn
            </label>
          </div>
        </div>
        <div class="field is-grouped mt-3">
          <div class="control">
            <button id="ff-generate-btn" class="button is-primary">Generar ideas</button>
          </div>
          <div class="control">
            <button id="ff-logout-btn" class="button is-danger">Cerrar sesi√≥n</button>
          </div>
        </div>
      </div>
      <!-- RESULTADOS -->
      <div id="ff-results-container" class="mt-4"></div>
    </div>

    <!-- Panel premium solo visible si el usuario es admin (esto es solo el contenedor, l√≥gica en JS) -->
    <div id="ff-admin-view" class="box mt-5 is-hidden">
      <h3 class="title is-5">Panel Admin Premium</h3>
      <label class="checkbox">
        <input type="checkbox" id="ff-toggle-premium-global" />
        Activar premium global
      </label>
      <input type="date" id="ff-premium-end-date" />
      <button id="ff-set-premium-btn" class="button is-primary is-small">Actualizar global</button>
      <div id="ff-premium-status-text" class="mt-3"></div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="footer has-text-centered mt-6">
    <p id="ff-footer-disclaimer" class="is-size-7">
      Aplicaci√≥n experimental para generaci√≥n de ideas en redes sociales. Desarrollado con üí° en Latinoam√©rica.
    </p>
    <p id="ff-footer-legal" class="is-size-7">
      FeedFlow no se hace responsable por los contenidos generados por inteligencia artificial.
    </p>
    <p id="ff-footer-copy" class="is-size-7 has-text-grey">
      Desarrollado por FeedFlow ¬∑ 2025
    </p>
  </footer>

  <!-- SCRIPT CENTRALIZADO -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";
    // Para Firestore (premium/admin)
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCScJA-UGs3WcBnfAm-6K94ybZ4bzBahz8",
      authDomain: "brain-storm-8f0d8.firebaseapp.com",
      projectId: "brain-storm-8f0d8",
      storageBucket: "brain-storm-8f0d8.appspot.com",
      messagingSenderId: "401208607043",
      appId: "1:401208607043:web:6f35fc81fdce7b3fbeaff6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const functions = getFunctions(app);
    const db = getFirestore(app);

    // Login con Google
    document.getElementById("ff-google-login").addEventListener("click", async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
        // El cambio de vista lo maneja onAuthStateChanged
      } catch (error) {
        console.error("Error al iniciar sesi√≥n:", error);
        alert("Error al iniciar sesi√≥n. Intenta de nuevo.");
      }
    });

    // Logout
    document.getElementById("ff-logout-btn").addEventListener("click", async () => {
      try {
        await signOut(auth);
        // El cambio de vista lo maneja onAuthStateChanged
      } catch (error) {
        console.error("Error al cerrar sesi√≥n:", error);
      }
    });

    // Control de vistas seg√∫n estado de autenticaci√≥n
    onAuthStateChanged(auth, async user => {
      if (user) {
        document.getElementById("ff-auth-view").classList.add("is-hidden");
        document.getElementById("ff-config-view").classList.remove("is-hidden");
        console.log("Usuario autenticado: ", user);
        await checkPremiumStatus(user.uid);
        await validarAdmin(user.uid);
      } else {
        document.getElementById("ff-config-view").classList.add("is-hidden");
        document.getElementById("ff-auth-view").classList.remove("is-hidden");
        document.getElementById("ff-admin-view").classList.add("is-hidden");
        document.querySelectorAll(".ff-ad")?.forEach(el => el.remove());
        console.log("Usuario autenticado: null");
      }
    });

    // L√ìGICA DE GENERACI√ìN DE IDEAS
    document.getElementById("ff-generate-btn").addEventListener("click", async () => {
      const user = auth.currentUser;
      const keyword = document.getElementById("ff-keyword").value.trim();
      const copytype = document.getElementById("ff-copytype").value;
      const language = document.getElementById("ff-auth-language-selector").value || "es";
      const mode = document.getElementById("ff-mode-selector").value;
      const networkCheckboxes = document.querySelectorAll(".ff-social:checked");
      const networks = Array.from(networkCheckboxes).map(el => el.value);

      const container = document.getElementById("ff-results-container");
      if (!user || !keyword || !copytype || !mode || networks.length === 0) {
        alert("Por favor, completa los campos requeridos.");
        return;
      }

      container.innerHTML = `<div class="notification is-info">Generando ideas...</div>`;

      try {
        const generateIdeasFn = httpsCallable(functions, "generateIdeas");
        const response = await generateIdeasFn({ keyword, copytype, language, networks, mode });
        console.log("üì• Respuesta recibida:", response.data);

        if (response.data.success && response.data.ideas.length > 0) {
          container.innerHTML = "";
          response.data.ideas.forEach((idea, index) => {
            const card = document.createElement("div");
            card.className = "card mb-3 p-3";

            const content = document.createElement("div");
            content.className = "content";
            content.innerHTML = `<strong>Idea ${index + 1}:</strong> ${idea.text}`;

            const copyBtn = document.createElement("button");
            copyBtn.className = "button is-small is-success mt-2";
            copyBtn.textContent = "Copiar";
            copyBtn.onclick = () => {
              navigator.clipboard.writeText(idea.text);
              alert("¬°Texto copiado!");
            };

            // Feedback buttons
            const feedbackDiv = document.createElement("div");
            feedbackDiv.className = "mt-2";
            ["üëç", "üëé"].forEach(type => {
              const btn = document.createElement("button");
              btn.className = "button is-small ff-feedback-btn";
              btn.dataset.feedback = (type === "üëç") ? "positivo" : "negativo";
              btn.dataset.ideaIndex = index;
              btn.innerHTML = type;
              feedbackDiv.appendChild(btn);
            });

            card.appendChild(content);
            card.appendChild(copyBtn);
            card.appendChild(feedbackDiv);
            container.appendChild(card);
          });
        } else {
          container.innerHTML = `<div class="notification is-warning">No se generaron ideas. Intenta con otra palabra clave.</div>`;
        }
      } catch (error) {
        console.error("Error al generar ideas:", error);
        container.innerHTML = `<div class="notification is-danger">Hubo un error al generar las ideas.</div>`;
      }
    });

    // CONTROL DE REDES SEG√öN MODO
    const modeSelector = document.getElementById("ff-mode-selector");
    const socialCheckboxes = document.querySelectorAll(".ff-social");

    function actualizarRestriccionesRedes() {
      const modo = modeSelector.value;
      socialCheckboxes.forEach(cb => {
        cb.checked = false;
        cb.disabled = false;
      });
      if (modo === "individual") {
        socialCheckboxes.forEach(cb => {
          cb.addEventListener("change", function () {
            if (this.checked) {
              socialCheckboxes.forEach(other => {
                if (other !== this) {
                  other.checked = false;
                  other.disabled = true;
                }
              });
            } else {
              socialCheckboxes.forEach(cb => cb.disabled = false);
            }
          });
        });
      }
    }
    modeSelector.addEventListener("change", actualizarRestriccionesRedes);
    document.addEventListener("DOMContentLoaded", actualizarRestriccionesRedes);

    // FEEDBACK DE IDEAS
    document.addEventListener("click", async (e) => {
      if (e.target.classList.contains("ff-feedback-btn")) {
        const feedbackType = e.target.dataset.feedback;
        const ideaIndex = e.target.dataset.ideaIndex;
        const user = auth.currentUser;
        if (!user) return;
        const recordFeedback = httpsCallable(functions, "recordIdeaFeedback");
        try {
          await recordFeedback({
            uid: user.uid,
            feedback: feedbackType,
            ideaIndex: Number(ideaIndex),
            timestamp: new Date().toISOString(),
          });
          document.getElementById("ff-feedback-modal").classList.add("is-active");
        } catch (error) {
          console.error("Error enviando feedback:", error);
          alert("Error al enviar feedback.");
        }
      }
    });

    document.getElementById("ff-close-feedback")?.addEventListener("click", () => {
      document.getElementById("ff-feedback-modal").classList.remove("is-active");
    });

    // PREMIUM Y PUBLICIDAD
    async function checkPremiumStatus(uid) {
      // Requiere estructura en Firestore: users/{uid}.premium (bool), appConfig/global.{isPremiumGlobalActive, premiumGlobalEndDate}
      try {
        const configRef = doc(db, "appConfig", "global");
        const configSnap = await getDoc(configRef);
        const userRef = doc(db, "users", uid);
        const userSnap = await getDoc(userRef);

        let isPremium = false;
        let showAds = true;

        if (userSnap.exists()) {
          isPremium = userSnap.data().premium || false;
        }

        if (configSnap.exists()) {
          const global = configSnap.data();
          const now = new Date();
          const endDate = new Date(global.premiumGlobalEndDate);
          if (global.isPremiumGlobalActive && now < endDate) {
            isPremium = true;
            showAds = global.isLaunchPromoActive; // En promo se permiten ads completas
          }
        }

        document.querySelectorAll(".ff-ad")?.forEach(el => el.remove());

        if (!isPremium) {
          // Mostrar publicidad completa
          const ad = document.createElement("div");
          ad.className = "notification is-warning has-text-centered ff-ad";
          ad.innerHTML = "Publicidad: ¬°Explora nuestra versi√≥n Premium sin anuncios!";
          document.body.appendChild(ad);
        } else if (showAds) {
          // Mostrar publicidad discreta
          const ad = document.createElement("div");
          ad.className = "has-text-centered has-text-grey-light ff-ad";
          ad.innerHTML = "<small>Publicidad moderada activa por promoci√≥n.</small>";
          document.body.appendChild(ad);
        }
      } catch (error) {
        console.error("Error comprobando premium:", error);
      }
    }

    // PANEL PREMIUM ADMIN
    async function validarAdmin(uid) {
      try {
        const userRef = doc(db, "users", uid);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists() && userSnap.data().role === "admin") {
          document.getElementById("ff-admin-view").classList.remove("is-hidden");
        } else {
          document.getElementById("ff-admin-view").classList.add("is-hidden");
        }
      } catch (error) {
        console.error("Error validando admin:", error);
      }
    }

    document.getElementById("ff-set-premium-btn").addEventListener("click", async () => {
      const isActive = document.getElementById("ff-toggle-premium-global").checked;
      const endDate = document.getElementById("ff-premium-end-date").value;
      const setPremiumGlobal = httpsCallable(functions, "setPremiumGlobalStatus");
      try {
        await setPremiumGlobal({
          isPremiumGlobalActive: isActive,
          premiumGlobalEndDate: new Date(endDate).toISOString()
        });
        document.getElementById("ff-premium-status-text").textContent =
          `Premium global activo hasta: ${new Date(endDate).toLocaleString()}`;
        alert("Actualizaci√≥n exitosa.");
      } catch (error) {
        console.error("Error actualizando premium global:", error);
        alert("Error al actualizar estado global.");
      }
    });

    // Hacer accesibles instancias globalmente
    window.auth = auth;
    window.functions = functions;
    window.db = db;
  </script>
</body>
</html>
