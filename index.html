<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador de Ideas para Contenido</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* Estilos personalizados (los mismos que antes, mantenlos) */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f7f6;
      color: #363636;
    }

    .navbar {
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* ... (resto de tus estilos CSS se mantienen) ... */
    .footer {
      background-color: #363636;
      color: #fff;
      padding: 3rem 1.5rem 3rem;
    }

    .footer a {
      color: #ff6f61;
    }

    .footer a:hover {
      color: #e65a50;
    }

    .disclaimer {
      font-size: 0.8rem;
      color: #ccc;
      margin-top: 1rem;
    }

    .generation-status-message {
      /* Para el mensaje de cuántas ideas se generaron */
      font-weight: bold;
    }

    .card .content p,
    .card .content strong,
    .card-header-title {
      color: #2c3e50 !important;
      /* Un color oscuro y legible */
      background-color: transparent !important;
      /* Asegurar que no haya fondos extraños para el texto en sí */
    }

    .card {
      background-color: white !important;
      /* Asegurar que la tarjeta tenga un fondo opaco */
      /* Puedes añadir un borde si quieres verlo claramente en el PDF */
      /* border: 1px solid #dbdbdb; */
    }

    /* Para asegurar que el contenedor principal también tenga fondo si es necesario */
    #ideasResultsArea {
      background-color: white;
      /* O el color de fondo de tu appView si es diferente */
    }
  </style>
</head>

<body>
  <div id="loadingOverlay" class="is-hidden">
    <div class="loader is-loading"></div>
    <p style="margin-left: 10px;">Cargando...</p>
  </div>

  <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
      <a class="navbar-item" href="#">
        <strong class="title is-4">Brain Storm</strong>
      </a>
      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarMenuCore">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div id="navbarMenuCore" class="navbar-menu">
      <div class="navbar-start">
      </div>

      <div class="navbar-end">
        <div class="navbar-item">
          <div class="buttons">
            <a id="navRegisterButton" class="button is-primary"> <strong>Registrarse</strong>
            </a>
            <a id="navLoginButton" class="button is-light"> Iniciar Sesión
            </a>
            <button id="navHistoryButton" class="button is-link is-hidden"> <span class="icon"><i
                  class="fas fa-history"></i></span>
              <span>Historial</span>
            </button>
            <button id="navLogoutButton" class="button is-danger is-hidden"> <span class="icon"><i
                  class="fas fa-sign-out-alt"></i></span>
              <span>Cerrar Sesión</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <section id="authView" class="section">
    <div class="container">
      <div class="columns is-centered">
        <div class="column is-half">
          <div id="loginBox">
            <h2 class="title is-3 has-text-centered">Iniciar Sesión</h2>
            <form id="loginForm" class="box">
              <div class="field">
                <label class="label" for="loginEmail">Correo Electrónico</label>
                <div class="control has-icons-left">
                  <input class="input" type="email" id="loginEmail" placeholder="tu@correo.com" required>
                  <span class="icon is-small is-left">
                    <i class="fas fa-envelope"></i>
                  </span>
                </div>
              </div>
              <div class="field">
                <label class="label" for="loginPassword">Contraseña</label>
                <div class="control has-icons-left">
                  <input class="input" type="password" id="loginPassword" placeholder="********" required>
                  <span class="icon is-small is-left">
                    <i class="fas fa-lock"></i>
                  </span>
                </div>
              </div>
              <div id="loginError" class="has-text-danger mb-2"></div> <button type="submit"
                class="button is-primary is-fullwidth">Entrar</button>
            </form>
            <p class="has-text-centered mt-4">
              ¿No tienes cuenta? <a href="#" id="showRegisterLink">Regístrate aquí</a>
            </p>
          </div>

          <div id="registerBox" class="is-hidden">
            <h2 class="title is-3 has-text-centered">Crear Cuenta</h2>
            <form id="registerForm" class="box">
              <div class="field">
                <label class="label" for="registerName">Nombre (opcional)</label>
                <div class="control has-icons-left">
                  <input class="input" type="text" id="registerName" placeholder="Tu Nombre">
                  <span class="icon is-small is-left">
                    <i class="fas fa-user"></i>
                  </span>
                </div>
              </div>
              <div class="field">
                <label class="label" for="registerEmail">Correo Electrónico</label>
                <div class="control has-icons-left">
                  <input class="input" type="email" id="registerEmail" placeholder="tu@correo.com" required>
                  <span class="icon is-small is-left">
                    <i class="fas fa-envelope"></i>
                  </span>
                </div>
              </div>
              <div class="field">
                <label class="label" for="registerPassword">Contraseña</label>
                <div class="control has-icons-left">
                  <input class="input" type="password" id="registerPassword" placeholder="********" required>
                  <span class="icon is-small is-left">
                    <i class="fas fa-lock"></i>
                  </span>
                </div>
              </div>
              <div id="registerError" class="has-text-danger mb-2"></div> <button type="submit"
                class="button is-success is-fullwidth">Crear Cuenta</button>
            </form>
            <p class="has-text-centered mt-4">
              ¿Ya tienes cuenta? <a href="#" id="showLoginLink">Inicia sesión aquí</a>
            </p>
          </div>

          <div class="divider">O</div>

          <button id="googleLoginButton" class="button is-danger is-fullwidth mt-4">
            <span class="icon"><i class="fab fa-google"></i></span>
            <span>Continuar con Google</span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <section id="appView" class="section is-hidden">
    <div class="container">
      <h1 class="title is-2" id="greeting">¡Hola!</h1>
      <p class="subtitle">Vamos a generar ideas increíbles para tu contenido.</p>

      <div class="columns">
        <div class="column is-one-third">
          <div id="formView">
            <div class="box">
              <div class="field">
                <label class="label" for="topicInput">Tema o Palabra Clave Principal</label>
                <div class="control">
                  <input class="input" list="topicSuggestions" type="text" id="topicInput"
                    placeholder="Ej: Marketing Digital para Principiantes">
                  <datalist id="topicSuggestions"></datalist>
                </div>
                <p class="coach-motivation">✨ ¡Sé preciso! Cuanto más preciso sea tu tema, más
                  brillantes serán las ideas. ✨</p>
              </div>

              <div class="field">
                <label class="label" for="copyTypeSelect">Tipo de Copy / Post</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="copyTypeSelect">
                      <option value="promocional" selected>Copy promocional</option>
                      <option value="informativo">Copy informativo</option>
                      <option value="emocional">Copy emocional</option>
                      <option value="cta">Copy con llamado a la acción (CTA)</option>
                      <option value="autoridad">Copy de autoridad o prueba social</option>
                      <option value="narrativo">Copy narrativo o storytelling</option>
                      <option value="urgencia">Copy de urgencia o escasez</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="field">
                <label class="label">Redes Sociales (selecciona una o varias)</label>
                <div id="socialNetworksContainer" class="control">
                  <label class="checkbox mr-2 mb-2">
                    <input type="checkbox" name="socialNetwork" value="Instagram"> Instagram
                  </label>
                  <label class="checkbox mr-2 mb-2">
                    <input type="checkbox" name="socialNetwork" value="Facebook"> Facebook
                  </label>
                  <label class="checkbox mr-2 mb-2">
                    <input type="checkbox" name="socialNetwork" value="X / Twitter"> X / Twitter
                  </label>
                  <label class="checkbox mr-2 mb-2">
                    <input type="checkbox" name="socialNetwork" value="LinkedIn"> LinkedIn
                  </label>
                  <label class="checkbox mr-2 mb-2">
                    <input type="checkbox" name="socialNetwork" value="TikTok"> TikTok
                  </label>
                  <label class="checkbox mr-2 mb-2">
                    <input type="checkbox" name="socialNetwork" value="YouTube"> YouTube
                  </label>
                  <label class="checkbox mr-2 mb-2">
                    <input type="checkbox" name="socialNetwork" value="Google Ads"> Google Ads
                  </label>
                </div>
              </div>

              <div class="field mt-5">
                <button id="generateIdeasButton"
                  class="button is-primary is-fullwidth is-large animate__animated animate__pulse animate__infinite">
                  <span class="icon"><i class="fas fa-lightbulb"></i></span>
                  <span>✨ ¡Generar Ideas! ✨</span>
                </button>
              </div>

              <div class="field mt-3">
                <button id="loadLastSearchButton" class="button is-text is-small is-fullwidth">Cargar
                  última configuración</button>
              </div>
            </div>
            <div class="field mt-3">
              <button id="exportUserHistoryCsvButton" class="button is-link is-outlined is-fullwidth">
                <span class="icon"><i class="fas fa-download"></i></span>
                <span>Exportar Últimas 50 Generaciones (CSV)</span>
              </button>
            </div>
          </div>
        </div>
        <div id="resultsView" class="column">
          <div id="actionButtonsContainer" class="mb-4 is-hidden has-text-right">
            <button id="backToFormButton" class="button is-light mr-2">
              <span class="icon"><i class="fas fa-arrow-left"></i></span>
              <span>Nueva Generación</span>
            </button>
            <button id="exportPdfButton" class="button is-success mr-2">
              <span class="icon"><i class="fas fa-file-pdf"></i></span>
              <span>Exportar a PDF</span>
            </button>
          </div>

          <div id="ideasResultsArea">
            <p id="noResultsMessage" class="has-text-centered has-text-grey">Completa los campos y haz clic
              en generar.</p>
          </div>

          <div id="finalPhraseContainer" class="is-hidden mt-4">
            <p id="finalPhraseText" class="has-text-centered is-italic"></p>
          </div>

          <div id="timerContainer" class="has-text-centered my-2"></div>
        </div>
      </div>
    </div>

    <div id="historyModal" class="modal">
    </div>

    <footer class="footer">
    </footer>

    <script type="module">
      // Importaciones de Firebase (sin cambios)
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; // Quité writeBatch ya que limitUserHistory usa admin SDK
      import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";


      // Configuración de Firebase (sin cambios)
      const firebaseConfig = {
        apiKey: "AIzaSyA6MZwE3_4K6CU0JTDVBG_c5GCgX5I00VE",
        authDomain: "brain-storm-8f0d8.firebaseapp.com",
        projectId: "brain-storm-8f0d8",
        storageBucket: "brain-storm-8f0d8.appspot.com",
        messagingSenderId: "401208607043",
        appId: "1:401208607043:web:6b4038ab14c9bee3beaff6"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const functions = getFunctions(app);

      // Selectores del DOM (algunos ya no se necesitarán)
      const loadingOverlay = document.getElementById('loadingOverlay');
      const authView = document.getElementById('authView');
      const appView = document.getElementById('appView');
      const greeting = document.getElementById('greeting');
      const navLoginButton = document.getElementById('navLoginButton');
      const navRegisterButton = document.getElementById('navRegisterButton');
      const navHistoryButton = document.getElementById('navHistoryButton');
      const navLogoutButton = document.getElementById('navLogoutButton');
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const googleLoginButton = document.getElementById('googleLoginButton');
      const loginError = document.getElementById('loginError'); // Para mostrar errores de login
      const registerError = document.getElementById('registerError'); // Para mostrar errores de registro
      const showRegisterLink = document.getElementById('showRegisterLink');
      const showLoginLink = document.getElementById('showLoginLink');
      const loginBox = document.getElementById('loginBox');
      const registerBox = document.getElementById('registerBox');
      // ... (otros selectores como login, register, navbar buttons se mantienen)

      const topicInput = document.getElementById('topicInput');
      const copyTypeSelect = document.getElementById('copyTypeSelect');
      const socialNetworksContainer = document.getElementById('socialNetworksContainer'); // NUEVO (para mensajes de error)
      const generateIdeasButton = document.getElementById('generateIdeasButton');
      const loadLastSearchButton = document.getElementById('loadLastSearchButton'); // NUEVO
      const exportUserHistoryCsvButton = document.getElementById('exportUserHistoryCsvButton'); // NUEVO
      const topicSuggestions = document.getElementById('topicSuggestions'); // NUEVO (el <datalist>)
      const formView = document.getElementById('formView'); // NUEVO
      const resultsView = document.getElementById('resultsView'); // NUEVO
      const ideasResultsArea = document.getElementById('ideasResultsArea');
      const noResultsMessage = document.getElementById('noResultsMessage');
      const finalPhraseContainer = document.getElementById('finalPhraseContainer');
      const finalPhraseText = document.getElementById('finalPhraseText');
      const actionButtonsContainer = document.getElementById('actionButtonsContainer');
      const backToFormButton = document.getElementById('backToFormButton'); // NUEVO
      const exportPdfButton = document.getElementById('exportPdfButton'); // Ya existía
      const timerContainer = document.getElementById('timerContainer'); // NUEVO

      // ... (selectores de historial y variables globales como currentUser se mantienen) ...
      let currentUser = null;
      let currentViewingSessionId = null; // Para saber qué sesión se está viendo o se acaba de generar
      let lastInputData = null; // Para "cargar última configuración" (NUEVO)

      const loadingPhrases = [ // NUEVO para el indicador de carga
        "Desatando la creatividad...",
        "Buscando la chispa de inspiración...",
        "Cocinando ideas frescas...",
        "Conectando neuronas creativas...",
        "Explorando el universo de las ideas...",
        "Puliendo conceptos brillantes...",
        "Tejiendo palabras que impactan...",
        "Dando forma a tu próxima gran idea...",
        "Afinando la estrategia de contenido...",
        "Generando magia para tus redes..."
      ];
      let phrasesIntervalId = null; // NUEVO para el indicador de carga
      // --- Funciones Auxiliares (showLoading, showTemporaryMessage, updateUIForAuthState sin cambios mayores) ---
      function showLoading(show) { /* ... sin cambios ... */ }
      function showTemporaryMessage(element, message, bulmaClass = 'is-danger', duration = 4000) { /* ... sin cambios ... */ }
      function updateUIForAuthState(user) { /* ... sin cambios, pero ahora llamará a clearSimplifiedGenerationForm ... */
        currentUser = user;
        if (user) {
          authView.classList.add('is-hidden');
          appView.classList.remove('is-hidden');
          greeting.textContent = `¡Hola, ${user.displayName || user.email}!`;
          navLoginButton.classList.add('is-hidden');
          navRegisterButton.classList.add('is-hidden');
          navHistoryButton.classList.remove('is-hidden');
          navLogoutButton.classList.remove('is-hidden');
          clearSimplifiedGenerationForm(); // <--- Usar la nueva función de limpiar
          clearResultsArea();
          currentViewingSessionId = null;
        } else {
          // ... (resto sin cambios)
          authView.classList.remove('is-hidden');
          appView.classList.add('is-hidden');
          greeting.textContent = '¡Hola!';
          navLoginButton.classList.remove('is-hidden');
          navRegisterButton.classList.remove('is-hidden');
          navHistoryButton.classList.add('is-hidden');
          navLogoutButton.classList.add('is-hidden');
          loginError.textContent = '';
          registerError.textContent = '';
          currentViewingSessionId = null;
        }
      }

      function clearSimplifiedGenerationForm() {
        topicInput.value = '';
        copyTypeSelect.value = 'promocional'; // Valor por defecto del nuevo select de Tipo de Copy

        // Limpiar todas las casillas de redes sociales
        document.querySelectorAll('input[name="socialNetwork"]:checked').forEach(checkbox => {
          checkbox.checked = false;
        });
        // Opcional: podrías decidir si quieres que `lastInputData` se limpie aquí o no.
        // Si quieres que se limpie para que "cargar última" no recuerde nada tras un logout/login:
        // lastInputData = null;
        // localStorage.removeItem('lastInputData');
      }

      function clearResultsArea() { /* ... sin cambios ... */ }


      // --- Lógica de Autenticación (sin cambios) ---
      onAuthStateChanged(auth, updateUIForAuthState);
      // ... (todo el código de login, registro, google login, logout se mantiene igual) ...
      if (navLogoutButton) { // Buena práctica: verificar que el elemento existe
        navLogoutButton.addEventListener('click', async () => {
          try {
            await signOut(auth); // Llama a la función de Firebase para cerrar sesión
            console.log("Usuario cerró sesión exitosamente.");
            // updateUIForAuthState se llamará automáticamente gracias a onAuthStateChanged
          } catch (error) {
            console.error("Error al cerrar sesión:", error);
            // showTemporaryMessage(algúnElementoParaMensajes, `Error al cerrar sesión: ${error.message}`, 'is-danger');
          }
        });
      }
      if (showRegisterLink && showLoginLink && loginBox && registerBox) {
        showRegisterLink.addEventListener('click', (e) => {
          e.preventDefault();
          loginBox.classList.add('is-hidden');
          registerBox.classList.remove('is-hidden');
        });

        showLoginLink.addEventListener('click', (e) => {
          e.preventDefault();
          registerBox.classList.add('is-hidden');
          loginBox.classList.remove('is-hidden');
        });
      }

      if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (loginError) loginError.textContent = ''; // Limpiar error previo
          const email = document.getElementById('loginEmail').value;
          const password = document.getElementById('loginPassword').value;
          try {
            showLoading(true);
            await signInWithEmailAndPassword(auth, email, password);
            // onAuthStateChanged se encargará de actualizar la UI y ocultar showLoading
          } catch (error) {
            console.error("Error al iniciar sesión:", error.message);
            if (loginError) loginError.textContent = `Error: ${error.message}`;
            showLoading(false);
          }
        });
      }

      if (registerForm) {
        registerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (registerError) registerError.textContent = ''; // Limpiar error previo
          const name = document.getElementById('registerName').value;
          const email = document.getElementById('registerEmail').value;
          const password = document.getElementById('registerPassword').value;
          try {
            showLoading(true);
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            if (name.trim() !== '') {
              await updateProfile(userCredential.user, { displayName: name.trim() });
              console.log("Perfil actualizado con displayName:", name.trim()); // Para depurar
            } else {
              console.log("No se proveyó nombre, displayName no se actualizó."); // Para depurar
            }
            // onAuthStateChanged se encargará de actualizar la UI y ocultar showLoading
          } catch (error) {
            console.error("Error al registrar:", error.message);
            if (registerError) registerError.textContent = `Error: ${error.message}`;
            showLoading(false);
          }
        });
      }

      if (googleLoginButton) {
        googleLoginButton.addEventListener('click', async () => {
          const provider = new GoogleAuthProvider(); // Crear instancia del proveedor
          try {
            showLoading(true);
            const result = await signInWithPopup(auth, provider); // Llamar a signInWithPopup
            // const user = result.user; // Aquí tienes el usuario de Google
            // onAuthStateChanged se encargará de la UI
          } catch (error) {
            console.error("Error con Google Sign-In:", error);
            if (loginError) loginError.textContent = `Error con Google: ${error.code} - ${error.message}`; // Mostrar más detalles
            if (timerContainer) timerContainer.innerHTML = ''; // Limpiar frases si se queda en authView
            showLoading(false);
          }
        });
      }
      // --- Lógica de la Aplicación Principal (MODIFICADA) ---
      // ELIMINADA la lógica de listeners para audienceTypeRadios, includeLocationCheckbox
      // ELIMINADA la llamada a renderAudienceGroups

      generateIdeasButton.addEventListener('click', async () => {
        if (!currentUser) {
          showTemporaryMessage(noResultsMessage, "Debes iniciar sesión para generar ideas.");
          return;
        }

        const topic = topicInput.value.trim();
        const copyType = copyTypeSelect.value;

        const selectedSocialNetworks = [];
        document.querySelectorAll('input[name="socialNetwork"]:checked').forEach((checkbox) => {
          selectedSocialNetworks.push(checkbox.value);
        });

        // Validaciones
        if (!topic) {
          showTemporaryMessage(topicInput.parentElement.parentElement, "El tema es obligatorio.", 'is-danger', 3000);
          topicInput.focus();
          return;
        }
        if (selectedSocialNetworks.length === 0) {
          showTemporaryMessage(socialNetworksContainer.parentElement, "Debes seleccionar al menos una red social.", 'is-danger', 3000);
          return;
        }

        // Guardar datos para "cargar última búsqueda"
        lastInputData = {
          topic: topic,
          copyType: copyType,
          socialNetworks: selectedSocialNetworks
        };
        localStorage.setItem('lastInputData', JSON.stringify(lastInputData));

        // --- Preparación de UI para Carga ---
        formView.classList.add('is-hidden');
        resultsView.classList.remove('is-hidden');
        ideasResultsArea.innerHTML = '';
        finalPhraseContainer.classList.add('is-hidden');
        actionButtonsContainer.classList.add('is-hidden');
        noResultsMessage.classList.add('is-hidden');
        timerContainer.innerHTML = ''; // Limpiar

        let currentPhraseIndex = 0;
        timerContainer.innerHTML = `<p class="has-text-info animate__animated animate__fadeIn">${loadingPhrases[currentPhraseIndex]}</p>`;
        phrasesIntervalId = setInterval(() => {
          currentPhraseIndex = (currentPhraseIndex + 1) % loadingPhrases.length;
          const phraseElement = timerContainer.querySelector('p');
          if (phraseElement) {
            phraseElement.classList.remove('animate__fadeIn');
            phraseElement.classList.add('animate__fadeOut');
            setTimeout(() => {
              if (timerContainer.contains(phraseElement)) { // Verificar si el elemento aún existe y es parte del DOM relevante
                phraseElement.textContent = loadingPhrases[currentPhraseIndex];
                phraseElement.classList.remove('animate__fadeOut');
                phraseElement.classList.add('animate__fadeIn');
              }
            }, 200);
          } else if (phrasesIntervalId) { // Si el P ya no existe pero el intervalo sí, crearlo de nuevo (poco probable si el contenedor existe)
            timerContainer.innerHTML = `<p class="has-text-info animate__animated animate__fadeIn">${loadingPhrases[currentPhraseIndex]}</p>`;
          }
        }, 3000);

        showLoading(true); // Overlay con spinner

        // --- Llamada a Firebase y Manejo de Resultados ---
        try {
          const generateIdeasFunction = httpsCallable(functions, 'generateIdeas');
          const result = await generateIdeasFunction({
            topic: topic,
            copyType: copyType,
            socialNetworks: selectedSocialNetworks
          });

          if (result.data && result.data.success) {
            currentViewingSessionId = result.data.sessionId;
            displayGeneratedIdeas(result.data.ideas); // Esto limpiará el timerContainer
            displayFinalPhrase(result.data.finalPhrase);
            actionButtonsContainer.classList.remove('is-hidden');
            // noResultsMessage se maneja dentro de displayGeneratedIdeas

            // Guardar tema en el historial de autocompletado
            const currentTopicForStorage = topicInput.value.trim(); // Usar el valor actual, no el 'topic' de arriba que podría ser de una carga anterior
            if (currentTopicForStorage) {
              let recentTopics = JSON.parse(localStorage.getItem('recentTopics')) || [];
              if (!recentTopics.some(rt => rt.toLowerCase() === currentTopicForStorage.toLowerCase())) {
                recentTopics.unshift(currentTopicForStorage);
                recentTopics = recentTopics.slice(0, 10);
                localStorage.setItem('recentTopics', JSON.stringify(recentTopics));
              }
            }
            // FIN de Guardar tema

            if (result.data.message) {
              const ideasContainer = ideasResultsArea; // Asegúrate que este es el contenedor correcto
              let messageType = 'is-success';
              if (result.data.ideas && result.data.ideas.length < selectedSocialNetworks.length && result.data.ideas.length > 0) {
                messageType = 'is-warning';
              } else if (!result.data.ideas || result.data.ideas.length === 0) {
                messageType = 'is-danger';
              }

              const generationStatusMessage = document.createElement('div');
              generationStatusMessage.classList.add('notification', messageType, 'is-light', 'mt-4', 'generation-status-message');
              generationStatusMessage.textContent = result.data.message;

              if (ideasContainer.querySelector('.card')) {
                ideasContainer.prepend(generationStatusMessage);
              } else {
                // No limpiar si displayGeneratedIdeas ya puso un mensaje de "no se generaron ideas"
                if (!ideasContainer.querySelector('#noResultsMessage') && !ideasContainer.querySelector('.notification')) {
                  ideasContainer.innerHTML = '';
                }
                ideasContainer.appendChild(generationStatusMessage);
              }
            }
          } else { // result.data.success es false o no hay result.data
            let errorMessageToShow = "No se pudieron generar las ideas (respuesta inesperada).";
            if (result.data && result.data.error) {
              errorMessageToShow = result.data.error;
            } else if (result.data && result.data.message) {
              errorMessageToShow = result.data.message;
            }
            ideasResultsArea.innerHTML = `<div class="notification is-danger">${errorMessageToShow}</div>`;
            if (timerContainer) timerContainer.innerHTML = ''; // Limpiar frases de carga
            actionButtonsContainer.classList.remove('is-hidden'); // Mostrar "Nueva Generación"
          }
        } catch (error) {
          console.error("Error al generar ideas:", error);
          ideasResultsArea.innerHTML = `<div class="notification is-danger">Error al generar ideas: ${error.message}</div>`;
          if (timerContainer) timerContainer.innerHTML = ''; // Limpiar frases de carga
          actionButtonsContainer.classList.remove('is-hidden'); // Mostrar "Nueva Generación"
        } finally {
          showLoading(false);
          if (phrasesIntervalId) {
            clearInterval(phrasesIntervalId);
            phrasesIntervalId = null; // importante para evitar múltiples intervalos
          }
          // No limpiar timerContainer aquí si displayGeneratedIdeas o el error ya lo hacen
          // o si quieres que el último mensaje de error/éxito de ideasResultsArea sea lo principal.
        }
      });

      // displayGeneratedIdeas y displayFinalPhrase (sin cambios en su lógica interna, pero displayGeneratedIdeas ya no mostrará ubicación)
      function displayGeneratedIdeas(ideas) {
        // Limpiar mensajes de estado de generación previos y el mensaje de "generando..." del timerContainer
        const existingStatusMessages = ideasResultsArea.querySelectorAll('.generation-status-message');
        existingStatusMessages.forEach(msg => msg.remove());
        if (timerContainer) timerContainer.innerHTML = ''; // Limpiar frases de carga/temporizador

        if (!ideas || ideas.length === 0) {
          // Si NO hay ideas, pero SÍ hay un mensaje de estado (ej. "la IA no devolvió..."), no lo sobrescribas.
          if (!ideasResultsArea.querySelector('.generation-status-message') && !ideasResultsArea.querySelector('.notification')) {
            ideasResultsArea.innerHTML = '<p id="noResultsMessage" class="has-text-centered has-text-grey">No se generaron ideas esta vez. Intenta ajustar tus parámetros o tema.</p>';
            if (noResultsMessage) noResultsMessage.classList.remove('is-hidden');
          }
          actionButtonsContainer.classList.remove('is-hidden'); // Mostrar botones para "Nueva Generación" aunque no haya ideas
          return;
        }

        // Si hay ideas, limpiar cualquier mensaje de "no resultados" o el de "generando"
        ideasResultsArea.innerHTML = '';
        if (noResultsMessage) noResultsMessage.classList.add('is-hidden');

        ideas.forEach((idea, index) => {
          const card = document.createElement('div');
          card.classList.add('card', 'mb-4', 'animate__animated', 'animate__fadeInUp'); // mb-4 para separar tarjetas
          card.style.animationDelay = `${index * 0.1}s`;

          const header = document.createElement('header');
          header.classList.add('card-header');

          const title = document.createElement('p');
          title.classList.add('card-header-title');
          // El backend ahora debería enviar 'redSocialTarget' en cada objeto 'idea'
          title.textContent = `Idea para: ${idea.redSocialTarget || 'Red Social Específica'}`;
          header.appendChild(title);
          card.appendChild(header);

          const contentDiv = document.createElement('div');
          contentDiv.classList.add('card-content');
          // El orden de los campos dentro del contenido cambia:
          contentDiv.innerHTML = ` 
                    <div class="content">
                        <p><strong>Gancho Verbal Impactante:</strong><br>${idea.ganchoVerbal || 'N/A'}</p>
                        <p><strong>Texto o Copy:</strong><br>${idea.textoCopy || 'N/A'}</p>
                        <p><strong>Hashtags:</strong><br>${Array.isArray(idea.hashtags) ? idea.hashtags.join(', ') : (idea.hashtags || 'N/A')}</p>
                        <p><strong>Formato Visual Sugerido:</strong><br>${idea.formatoVisual || 'N/A'}</p>
                    </div>
                `; // <--- ¡COMILLA INVERTIDA DE CIERRE!
          card.appendChild(contentDiv);
          ideasResultsArea.appendChild(card);
        });
        actionButtonsContainer.classList.remove('is-hidden'); // Mostrar botones de "Nueva Generación", "Exportar PDF"
      }

      function displayFinalPhrase(phrase) { /* ... sin cambios ... */ }
      backToFormButton.addEventListener('click', () => {
        resultsView.classList.add('is-hidden'); // Ocultar la vista de resultados
        if (timerContainer) timerContainer.innerHTML = ''; // Limpiar el contenedor de frases/timer
        ideasResultsArea.innerHTML = ''; // Limpiar el área de ideas por si acaso
        noResultsMessage.classList.remove('is-hidden'); // Mostrar el mensaje inicial
        finalPhraseContainer.classList.add('is-hidden');
        actionButtonsContainer.classList.add('is-hidden'); // Ocultar los botones de acción de resultados

        formView.classList.remove('is-hidden');   // Mostrar la vista del formulario

        clearSimplifiedGenerationForm(); // Limpiar los campos del formulario
        currentViewingSessionId = null; // Resetear el ID de la sesión que se estaba viendo
        topicInput.focus(); // Poner el cursor en el campo de tema
      });
      // Cargar datos al iniciar la app si existen en localStorage (esto puede ir cerca de donde defines `lastInputData`)
      const storedLastInput = localStorage.getItem('lastInputData');
      if (storedLastInput) {
        lastInputData = JSON.parse(storedLastInput);
      } else {
        lastInputData = { topic: '', copyType: 'promocional', socialNetworks: [] }; // Inicializar con valores por defecto si no hay nada guardado
      }

      loadLastSearchButton.addEventListener('click', () => {
        // Siempre intenta leer la versión más reciente de localStorage por si se guardó en otra pestaña (poco probable aquí pero buena práctica)
        const dataToLoad = JSON.parse(localStorage.getItem('lastInputData'));

        if (dataToLoad && typeof dataToLoad === 'object') {
          topicInput.value = dataToLoad.topic || '';
          copyTypeSelect.value = dataToLoad.copyType || 'promocional';

          // Limpiar checkboxes actuales antes de marcar los guardados
          document.querySelectorAll('input[name="socialNetwork"]').forEach(checkbox => checkbox.checked = false);
          if (dataToLoad.socialNetworks && Array.isArray(dataToLoad.socialNetworks)) {
            dataToLoad.socialNetworks.forEach(networkValue => {
              const checkbox = document.querySelector(`input[name = "socialNetwork"][value = "${networkValue}"]`);
              if (checkbox) {
                checkbox.checked = true;
              }
            });
          }
          showTemporaryMessage(loadLastSearchButton.parentElement, "Última configuración cargada.", 'is-success', 2000);
        } else {
          showTemporaryMessage(loadLastSearchButton.parentElement, "No hay configuración previa guardada.", 'is-info', 2000);
        }
      });
      exportUserHistoryCsvButton.addEventListener('click', async () => {
        if (!currentUser) {
          showTemporaryMessage(exportUserHistoryCsvButton.parentElement, "Debes iniciar sesión para exportar.", 'is-danger', 3000);
          return;
        }
        showLoading(true); // Muestra el overlay general de carga
        try {
          const exportHistoryFunc = httpsCallable(functions, 'exportUserHistoryCsv'); // Llamará a la NUEVA función backend
          const result = await exportHistoryFunc();

          if (result.data && result.data.success && typeof result.data.csv === 'string') {
            if (result.data.csv.length > 0) { // Solo descargar si hay contenido
              const blob = new Blob(["\uFEFF" + result.data.csv], { type: 'text/csv;charset=utf-8;' }); // BOM para UTF-8 en Excel
              const link = document.createElement("a");
              const url = URL.createObjectURL(blob);
              const userPrefix = currentUser.email ? currentUser.email.split('@')[0].replace(/[^a-zA-Z0-9]/g, "_") : currentUser.uid.substring(0, 5);
              link.setAttribute("href", url);
              link.setAttribute("download", `historial_ideas_${userPrefix}_${new Date().toISOString().slice(0, 10)}.csv`);
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url); // Liberar memoria
            } else {
              showTemporaryMessage(exportUserHistoryCsvButton.parentElement, result.data.message || "No hay datos en el historial para exportar.", 'is-info', 3000);
            }
          } else {
            showTemporaryMessage(exportUserHistoryCsvButton.parentElement, result.data.message || "Error al generar CSV del historial.", 'is-danger', 4000);
          }
        } catch (error) {
          console.error("Error al exportar historial CSV:", error);
          showTemporaryMessage(exportUserHistoryCsvButton.parentElement, `Error: ${error.message} `, 'is-danger', 4000);
        } finally {
          showLoading(false);
        }
      });
      function populateTopicSuggestions() {
        const recentTopics = JSON.parse(localStorage.getItem('recentTopics')) || [];
        topicSuggestions.innerHTML = ''; // Limpiar opciones previas
        recentTopics.forEach(topic => {
          const option = document.createElement('option');
          option.value = topic; // El texto que se autocompleta
          // option.textContent = topic; // Para algunos navegadores, si quieres que se muestre en la lista desplegable
          topicSuggestions.appendChild(option);
        });
      }

      // Llamar al cargar la página (después de que el DOM esté listo) y cuando el input reciba foco
      document.addEventListener('DOMContentLoaded', () => {
        populateTopicSuggestions(); // Para la carga inicial

        // También, cargar lastInputData aquí es un buen lugar
        const storedLastInputOnLoad = localStorage.getItem('lastInputData');
        if (storedLastInputOnLoad) {
          lastInputData = JSON.parse(storedLastInputOnLoad);
        } else {
          // Si no hay nada, podrías querer inicializar lastInputData con valores por defecto
          lastInputData = { topic: '', copyType: 'promocional', socialNetworks: [] };
        }
      });
      topicInput.addEventListener('focus', populateTopicSuggestions);
      // ELIMINADO listener de refreshIdeasButton

      // --- Lógica de Historial (MODIFICADA para no mostrar audiencia/ubicación) ---
      navHistoryButton.addEventListener('click', async () => { /* ... (la llamada a getHistorySummary es igual) ... */ });

      function renderHistoryList(historyItems) {
        historyListContainer.innerHTML = '';
        if (!historyItems || historyItems.length === 0) {
          historyListContainer.innerHTML = '<p class="has-text-centered">No tienes generaciones guardadas.</p>';
          return;
        }
        const list = document.createElement('div');
        list.classList.add('list', 'is-hoverable');
        historyItems.forEach(item => {
          const listItem = document.createElement('a');
          listItem.classList.add('list-item');
          listItem.dataset.sessionId = item.id;
          const timestampDate = item.timestamp && item.timestamp.seconds ? new Date(item.timestamp.seconds * 1000 + (item.timestamp.nanoseconds || 0) / 1000000) : null;
          const formattedTimestamp = timestampDate ? timestampDate.toLocaleString('es-ES') : 'Fecha desconocida';

          // Mostrar solo los campos relevantes
          listItem.innerHTML = `
            <div class="list-item-content">
                    <div class="list-item-title"><strong>Tema:</strong> ${item.topic || 'N/A'}</div>
                    <div class="list-item-description">
                        <small><strong>Fecha:</strong> ${formattedTimestamp}</small><br>
                        <small><strong>Tipo de Copy:</strong> ${item.copyType || 'N/A'}</small><br>
                        <small><strong>Redes Solicitadas:</strong> ${item.socialNetworks && Array.isArray(item.socialNetworks) ? item.socialNetworks.join(', ') : 'N/A'}</small>
                    </div>
                </div>
            `;
          listItem.addEventListener('click', () => { /* ... (lógica de selección sin cambios) ... */ });
          list.appendChild(listItem);
        });
        historyListContainer.appendChild(list);
      }

      // Inicialización y Burger menu (sin cambios)
      const burger = document.querySelector('.navbar-burger');
      const menu = document.querySelector('.navbar-menu');
      if (burger && menu) { /* ... sin cambios ... */ }
      document.addEventListener('DOMContentLoaded', () => { // Asegura que el DOM esté cargado
        const burgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

        if (burgers.length > 0) {
          burgers.forEach(el => {
            el.addEventListener('click', () => {
              // Obtener el target del atributo 'data-target'
              const target = el.dataset.target; // Debería ser 'navbarMenuCore'
              const $target = document.getElementById(target); // El div del menú

              // Alternar la clase 'is-active' en el burger y en el target del menú
              el.classList.toggle('is-active');
              if ($target) { // Verificar que $target no sea null
                $target.classList.toggle('is-active');
              } else {
                console.warn('Burger target not found:', target);
              }
            });
          });
        }

      });
      console.log("Aplicación simplificada de generación de ideas inicializada.");
      // --- Lógica de Exportación a PDF ---
      if (exportPdfButton && ideasResultsArea && actionButtonsContainer && typeof html2pdf !== 'undefined') {
        exportPdfButton.addEventListener('click', () => {
          // ...
          const clone = elementToExport.cloneNode(true);
          clone.style.position = 'fixed'; // CAMBIO: Para que sea visible sobre el contenido
          clone.style.left = '10px';      // CAMBIO: Posición visible
          clone.style.top = '10px';       // CAMBIO: Posición visible
          clone.style.zIndex = '19999';   // CAMBIO: Muy al frente, pero debajo de la previsualización si la tuvieras
          clone.style.border = '3px dashed red'; // CAMBIO: Borde visible para el clon
          clone.style.overflowY = 'scroll'; // CAMBIO: Permitir scroll si es muy alto
          clone.style.maxHeight = '80vh';   // CAMBIO: Limitar altura para que no ocupe toda la pantalla
          // Ya tenías display: 'block' que es bueno.

          // --- Aplicar estilos y ancho al clon ---
          const desiredPdfContentWidthPx = 750;
          clone.style.width = desiredPdfContentWidthPx + 'px';
          clone.style.backgroundColor = 'lightyellow'; // CAMBIO: Fondo amarillo claro para el CLON para distinguirlo
          clone.style.padding = '15px';
          clone.style.boxSizing = 'border-box';

          const elementsToStyle = clone.querySelectorAll('*');
          elementsToStyle.forEach(el => {
            el.style.wordWrap = 'break-word';
            el.style.overflowWrap = 'break-word';
            el.style.whiteSpace = 'normal';
            el.style.color = '#111';
            el.style.backgroundColor = 'transparent';
            // Asegurar que los elementos sean visibles
            const computedDisplay = window.getComputedStyle(el).display;
            const computedVisibility = window.getComputedStyle(el).visibility;

            if (computedDisplay === 'none') {
              console.log("Forzando display a 'block' para el elemento:", el);
              el.style.display = 'block';
            }
            if (computedVisibility === 'hidden') {
              console.log("Forzando visibility a 'visible' para el elemento:", el);
              el.style.visibility = 'visible';
            }
            // el.style.border = '1px dotted #eee'; // Para ver bordes internos
          });

          clone.querySelectorAll('.card').forEach(card => {
            card.style.border = '2px solid blue'; // CAMBIO: Borde azul para las tarjetas
            card.style.marginBottom = '15px';
            card.style.padding = '10px';
            card.style.backgroundColor = 'white'; // Fondo blanco para las tarjetas
            card.style.width = '100%';
            card.style.boxSizing = 'border-box';
            console.log("Estilos aplicados a la tarjeta:", card);
          });
          clone.querySelectorAll('.card-header-title, .card .content p, .card .content strong').forEach(el => {
            el.style.color = 'black'; // Asegurar que el texto sea negro
            // console.log(`Texto en clon: "${el.textContent.substring(0,50)}" Color: ${window.getComputedStyle(el).color}`);
          });
          // --- FIN Aplicar estilos ---

          document.body.appendChild(clone);
          console.log("CLON AÑADIDO AL BODY PARA INSPECCIÓN VISUAL. ¿Se ve el contenido?");

          setTimeout(() => {
            let currentCloneWidth = clone.scrollWidth;
            let currentCloneHeight = clone.scrollHeight;
            // ... (resto de la lógica de lectura de dimensiones, que ya estaba bien) ...
            console.log(`Dimensiones del clon DENTRO DEL TIMEOUT (scrollWidth, scrollHeight): ${currentCloneWidth}, ${currentCloneHeight}`);
            if (currentCloneWidth === 0 || currentCloneHeight === 0) {
              currentCloneWidth = clone.offsetWidth; currentCloneHeight = clone.offsetHeight;
            }
            if (currentCloneWidth === 0 || currentCloneHeight === 0) { /* ... error y return ... */ }

            // ... Tus logs de DEBUG CLON ...

            const pdfOptions = {
              margin: 0.5,
              filename: filename,
              image: { type: 'jpeg', quality: 0.95 },
              html2canvas: {
                scale: 1, // <--- CAMBIO: Empezar con escala 1 para simplificar
                logging: true,
                useCORS: true,
                width: currentCloneWidth,
                height: currentCloneHeight,
                backgroundColor: '#ffffff',
                windowHeight: currentCloneHeight,
                // OPCIÓN EXTRA para probar:
                // foreignObjectRendering: true, // A veces ayuda con ciertos contenidos
              },
              jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
              pagebreak: { mode: ['css', 'legacy'], before: '.card' }
            };
            console.log("Opciones FINALES para html2pdf (con html2canvas interno):", JSON.parse(JSON.stringify(pdfOptions)));

            html2pdf().from(clone).set(pdfOptions).save()
              .then(() => { console.log("PDF guardado exitosamente."); })
              .catch(err => { console.error("Error al generar PDF con html2pdf:", err); /* ... */ })
              .finally(() => {
                exportPdfButton.innerHTML = originalButtonText;
                exportPdfButton.disabled = false;
                // NO ELIMINAR EL CLON AÚN para poder inspeccionarlo
                // if (clone.parentNode) document.body.removeChild(clone);
                alert("Proceso de PDF terminado. Revisa el clon visible en la esquina y el PDF.");
              });
          }, 350); // Aumentar un poco más el timeout para dar tiempo a la inspección visual si es necesario
        });
      }    </script>
</body>

</html>
