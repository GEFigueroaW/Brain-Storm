<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Ideas para Contenido</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

    <style>
        /* Estilos personalizados (los mismos que antes, mantenlos) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            color: #363636;
        }

        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* ... (resto de tus estilos CSS se mantienen) ... */
        .footer {
            background-color: #363636;
            color: #fff;
            padding: 3rem 1.5rem 3rem;
        }

        .footer a {
            color: #ff6f61;
        }

        .footer a:hover {
            color: #e65a50;
        }

        .disclaimer {
            font-size: 0.8rem;
            color: #ccc;
            margin-top: 1rem;
        }

        .generation-status-message {
            /* Para el mensaje de cuántas ideas se generaron */
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div id="loadingOverlay" class="is-hidden">
        <div class="loader is-loading"></div>
        <p style="margin-left: 10px;">Cargando...</p>
    </div>

    <nav class="navbar" role="navigation" aria-label="main navigation">
    </nav>

    <section id="authView" class="section">
    </section>

    <section id="appView" class="section is-hidden">
        <div class="container">
            <h1 class="title is-2" id="greeting">¡Hola!</h1>
            <p class="subtitle">Vamos a generar ideas increíbles para tu contenido.</p>

            <div class="columns">
                <div class="column is-one-third">
                    <div id="formView">  <div class="box">
                        </div>
                    </div> </div> <div class="column">
                </div>
        </div>
                        <div class="field">
                            <label class="label" for="topicInput">Tema o Palabra Clave Principal</label>
                            <div class="control">
                                <input class="input" type="text" id="topicInput"
                                    placeholder="Ej: Marketing Digital para Principiantes">
                            </div>
                            <p class="coach-motivation">✨ ¡Sé preciso! Cuanto más preciso sea tu tema, más brillantes
                                serán las ideas. ✨</p>
                        </div>

                    <div class="field">
                        <label class="label" for="copyTypeSelect">Tipo de Copy / Post</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select id="copyTypeSelect">
                                    <option value="promocional" selected>Copy promocional</option>
                                    <option value="informativo">Copy informativo</option>
                                    <option value="emocional">Copy emocional</option>
                                    <option value="cta">Copy con llamado a la acción (CTA)</option>
                                    <option value="autoridad">Copy de autoridad o prueba social</option>
                                    <option value="narrativo">Copy narrativo o storytelling</option>
                                    <option value="urgencia">Copy de urgencia o escasez</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">Redes Sociales (selecciona una o varias)</label>
                        <div id="socialNetworksContainer" class="control">
                            <label class="checkbox mr-2 mb-2">
                                <input type="checkbox" name="socialNetwork" value="Instagram"> Instagram
                            </label>
                            <label class="checkbox mr-2 mb-2">
                                <input type="checkbox" name="socialNetwork" value="Facebook"> Facebook
                            </label>
                            <label class="checkbox mr-2 mb-2">
                                <input type="checkbox" name="socialNetwork" value="X / Twitter"> X / Twitter
                            </label>
                            <label class="checkbox mr-2 mb-2">
                                <input type="checkbox" name="socialNetwork" value="LinkedIn"> LinkedIn
                            </label>
                            <label class="checkbox mr-2 mb-2">
                                <input type="checkbox" name="socialNetwork" value="TikTok"> TikTok
                            </label>
                            <label class="checkbox mr-2 mb-2">
                                <input type="checkbox" name="socialNetwork" value="YouTube"> YouTube
                            </label>
                            <label class="checkbox mr-2 mb-2">
                                <input type="checkbox" name="socialNetwork" value="Google Ads"> Google Ads
                            </label>
                        </div>
                    </div>
                        <div class="field mt-5">
                            <button id="generateIdeasButton"
                                class="button is-primary is-fullwidth is-large animate__animated animate__pulse animate__infinite">
                                <span class="icon"><i class="fas fa-lightbulb"></i></span>
                                <span>✨ ¡Generar Ideas! ✨</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="resultsView" class="column"> <div id="actionButtonsContainer" class="mb-4 is-hidden has-text-right">
                    <div id="actionButtonsContainer" class="mb-4 is-hidden has-text-right">
                        <button id="exportPdfButton" class="button is-success mr-2">
                            <span class="icon"><i class="fas fa-file-pdf"></i></span>
                            <span>Exportar a PDF</span>
                        </button>
                        <button id="exportCsvButton" class="button is-info">
                            <span class="icon"><i class="fas fa-file-csv"></i></span>
                            <span>Exportar a CSV</span>
                        </button>
                    </div>
                    <div id="ideasResultsArea">
                        <p id="noResultsMessage" class="has-text-centered has-text-grey">Completa los campos y haz clic
                            en generar.</p>
                    </div>
                    <div id="finalPhraseContainer" class="is-hidden">
                        <p id="finalPhraseText"></p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="historyModal" class="modal">
    </div>

    <footer class="footer">
    </footer>

    <script type="module">
        // Importaciones de Firebase (sin cambios)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; // Quité writeBatch ya que limitUserHistory usa admin SDK
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";


        // Configuración de Firebase (sin cambios)
        const firebaseConfig = {
            apiKey: "AIzaSyA6MZwE3_4K6CU0JTDVBG_c5GCgX5I00VE",
            authDomain: "brain-storm-8f0d8.firebaseapp.com",
            projectId: "brain-storm-8f0d8",
            storageBucket: "brain-storm-8f0d8.appspot.com",
            messagingSenderId: "401208607043",
            appId: "1:401208607043:web:6b4038ab14c9bee3beaff6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);

        // Selectores del DOM (algunos ya no se necesitarán)
        const loadingOverlay = document.getElementById('loadingOverlay');
        const authView = document.getElementById('authView');
        const appView = document.getElementById('appView');
        const greeting = document.getElementById('greeting');
        const navLoginButton = document.getElementById('navLoginButton');
        const navRegisterButton = document.getElementById('navRegisterButton');
        const navHistoryButton = document.getElementById('navHistoryButton');
        const navLogoutButton = document.getElementById('navLogoutButton');
        // ... (otros selectores como login, register, navbar buttons se mantienen)

        // ELIMINADOS Selectores de Audiencia y Ubicación:
        // const audienceTypeRadios = document.querySelectorAll('input[name="audienceType"]');
        // const targetAudienceSection = document.getElementById('targetAudienceSection');
        // const audienceGroupsContainer = document.getElementById('audienceGroupsContainer');
        // const subAudienceCounter = document.getElementById('subAudienceCounter');
        // const audienceError = document.getElementById('audienceError');
        // const includeLocationCheckbox = document.getElementById('includeLocationCheckbox');
        // const locationInputContainer = document.getElementById('locationInputContainer');
        // const locationInput = document.getElementById('locationInput');

        const topicInput = document.getElementById('topicInput');
        const toneSelect = document.getElementById('toneSelect');
        const maxWordsInput = document.getElementById('maxWordsInput');
        const generateIdeasButton = document.getElementById('generateIdeasButton');

        const ideasResultsArea = document.getElementById('ideasResultsArea');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const finalPhraseContainer = document.getElementById('finalPhraseContainer');
        const finalPhraseText = document.getElementById('finalPhraseText');
        const actionButtonsContainer = document.getElementById('actionButtonsContainer');
        // ELIMINADO selector de refreshIdeasButton
        const exportPdfButton = document.getElementById('exportPdfButton');
        const exportCsvButton = document.getElementById('exportCsvButton');

        // ... (selectores de historial y variables globales como currentUser se mantienen) ...
        let currentUser = null;
        let currentViewingSessionId = null;


        // --- Funciones Auxiliares (showLoading, showTemporaryMessage, updateUIForAuthState sin cambios mayores) ---
        function showLoading(show) { /* ... sin cambios ... */ }
        function showTemporaryMessage(element, message, bulmaClass = 'is-danger', duration = 4000) { /* ... sin cambios ... */ }
        function updateUIForAuthState(user) { /* ... sin cambios, pero ahora llamará a clearSimplifiedGenerationForm ... */
            currentUser = user;
            if (user) {
                authView.classList.add('is-hidden');
                appView.classList.remove('is-hidden');
                greeting.textContent = `¡Hola, ${user.displayName || user.email}!`;
                navLoginButton.classList.add('is-hidden');
                navRegisterButton.classList.add('is-hidden');
                navHistoryButton.classList.remove('is-hidden');
                navLogoutButton.classList.remove('is-hidden');
                clearSimplifiedGenerationForm(); // <--- Usar la nueva función de limpiar
                clearResultsArea();
                currentViewingSessionId = null;
            } else {
                // ... (resto sin cambios)
                authView.classList.remove('is-hidden');
                appView.classList.add('is-hidden');
                greeting.textContent = '¡Hola!';
                navLoginButton.classList.remove('is-hidden');
                navRegisterButton.classList.remove('is-hidden');
                navHistoryButton.classList.add('is-hidden');
                navLogoutButton.classList.add('is-hidden');
                loginError.textContent = '';
                registerError.textContent = '';
                currentViewingSessionId = null;
            }
        }

        function clearSimplifiedGenerationForm() { // Nueva función para limpiar los campos simplificados
            topicInput.value = '';
            toneSelect.value = 'Neutral';
            maxWordsInput.value = 100;
        }

        function clearResultsArea() { /* ... sin cambios ... */ }


        // --- Lógica de Autenticación (sin cambios) ---
        onAuthStateChanged(auth, updateUIForAuthState);
        // ... (todo el código de login, registro, google login, logout se mantiene igual) ...


        // --- Lógica de la Aplicación Principal (MODIFICADA) ---
        // ELIMINADA la lógica de listeners para audienceTypeRadios, includeLocationCheckbox
        // ELIMINADA la llamada a renderAudienceGroups

        generateIdeasButton.addEventListener('click', async () => {
            if (!currentUser) {
                showTemporaryMessage(noResultsMessage, "Debes iniciar sesión para generar ideas.");
                return;
            }

            const topic = topicInput.value.trim();
            const tone = toneSelect.value;
            const maxWords = parseInt(maxWordsInput.value, 10);

            // Validaciones simplificadas
            if (!topic) {
                showTemporaryMessage(topicInput.parentElement, "El tema es obligatorio.", 'is-danger', 3000); // Asumiendo que el <p> está fuera del control
                topicInput.focus();
                return;
            }
            if (isNaN(maxWords) || maxWords < 50 || maxWords > 500) {
                showTemporaryMessage(maxWordsInput.parentElement, "Máximo de palabras debe ser entre 50 y 500.", 'is-danger', 3000);
                maxWordsInput.focus();
                return;
            }

            showLoading(true);
            // Limpiar mensajes de estado de generación anteriores
            const existingStatusMessages = ideasResultsArea.querySelectorAll('.generation-status-message');
            existingStatusMessages.forEach(msg => msg.remove());
            ideasResultsArea.innerHTML = '<p class="has-text-centered">✨ Generando ideas...</p>';
            finalPhraseContainer.classList.add('is-hidden');
            actionButtonsContainer.classList.add('is-hidden');

            try {
                const generateIdeasFunction = httpsCallable(functions, 'generateIdeas');
                const result = await generateIdeasFunction({
                    topic: topic,
                    tone: tone,
                    maxWords: maxWords,
                    // Ya no se envían audienceType, audienceDetails, includeLocation, locationInput
                });

                // Manejo de la respuesta MODIFICADO (Punto 10)
                if (result.data && result.data.success) {
                    currentViewingSessionId = result.data.sessionId;
                    displayGeneratedIdeas(result.data.ideas); // Esta función ya debe estar preparada para mostrar lo que reciba
                    displayFinalPhrase(result.data.finalPhrase);
                    actionButtonsContainer.classList.remove('is-hidden');
                    noResultsMessage.classList.add('is-hidden');

                    if (result.data.message) {
                        const ideasContainer = ideasResultsArea;
                        let messageType = 'is-success';
                        if (result.data.ideas && result.data.ideas.length < 5 && result.data.ideas.length > 0) {
                            messageType = 'is-warning';
                        } else if (!result.data.ideas || result.data.ideas.length === 0) {
                            // Si la función backend ahora solo lanza error si ideas.length es 0, este caso no se dará aquí
                            // sino en el catch. Pero por si acaso.
                            messageType = 'is-danger';
                        }

                        const generationStatusMessage = document.createElement('div');
                        generationStatusMessage.classList.add('notification', messageType, 'is-light', 'mt-4', 'generation-status-message');
                        generationStatusMessage.textContent = result.data.message;

                        // Si hay tarjetas de ideas, poner el mensaje antes de la primera. Sino, reemplazar el contenido.
                        if (ideasContainer.querySelector('.card')) {
                            ideasContainer.prepend(generationStatusMessage);
                        } else {
                            ideasResultsArea.innerHTML = ''; // Limpiar "No se generaron ideas" si el mensaje lo reemplaza
                            ideasResultsArea.appendChild(generationStatusMessage);
                        }
                    }
                } else {
                    // Si success es false, o no hay data, usar el error o mensaje de la función
                    let errorMessageToShow = "No se pudieron generar las ideas.";
                    if (result.data && result.data.error) {
                        errorMessageToShow = result.data.error;
                    } else if (result.data && result.data.message) {
                        errorMessageToShow = result.data.message;
                    }
                    // El error HttpsError lanzado por la función se captura en el bloque catch.
                    // Este else sería para casos donde success:false pero no es un HttpsError.
                    ideasResultsArea.innerHTML = `<div class="notification is-danger">${errorMessageToShow}</div>`;
                }
            } catch (error) {
                console.error("Error al generar ideas:", error);
                // El HttpsError de la función (ej. "La IA no devolvió ninguna idea...") vendrá aquí en error.message
                ideasResultsArea.innerHTML = `<div class="notification is-danger">Error al generar ideas: ${error.message}</div>`;
            } finally {
                showLoading(false);
            }
        });

        // displayGeneratedIdeas y displayFinalPhrase (sin cambios en su lógica interna, pero displayGeneratedIdeas ya no mostrará ubicación)
        function displayGeneratedIdeas(ideas) {
            // Limpiar mensajes de estado de generación previos antes de añadir nuevas ideas
            const existingStatusMessages = ideasResultsArea.querySelectorAll('.generation-status-message');
            existingStatusMessages.forEach(msg => msg.remove());

            if (!ideas || ideas.length === 0) { // Si no hay ideas, pero hubo un mensaje, no sobreescribir el mensaje.
                if (!ideasResultsArea.querySelector('.generation-status-message')) {
                    ideasResultsArea.innerHTML = '<p class="has-text-centered">No se generaron ideas. Intenta ajustar tus parámetros.</p>';
                }
                return;
            }
            // Si hay ideas, limpiar cualquier mensaje de "no resultados" o el de "generando"
            ideasResultsArea.innerHTML = '';


            ideas.forEach((idea, index) => {
                const card = document.createElement('div');
                card.classList.add('card', 'animate__animated', 'animate__fadeInUp');
                card.style.animationDelay = `${index * 0.1}s`;
                const header = document.createElement('header');
                header.classList.add('card-header');
                const title = document.createElement('p');
                title.classList.add('card-header-title');
                title.textContent = `Idea ${index + 1}`;
                header.appendChild(title);
                card.appendChild(header);
                const contentDiv = document.createElement('div');
                contentDiv.classList.add('card-content');
                contentDiv.innerHTML = `
                    <div class="content">
                        <p><strong>Texto o Copy:</strong></p>
                        <p>${idea.textoCopy || 'N/A'}</p>
                        <p><strong>Hashtags:</strong> ${Array.isArray(idea.hashtags) ? idea.hashtags.join(', ') : (idea.hashtags || 'N/A')}</p>
                        <p><strong>Formato Visual Sugerido:</strong> ${idea.formatoVisual || 'N/A'}</p>
                        <p><strong>Gancho Verbal Impactante:</strong> ${idea.ganchoVerbal || 'N/A'}</p>
                        </div>
                `;
                card.appendChild(contentDiv);
                ideasResultsArea.appendChild(card);
            });
        }
        function displayFinalPhrase(phrase) { /* ... sin cambios ... */ }

        // ELIMINADO listener de refreshIdeasButton

        // --- Lógica de Historial (MODIFICADA para no mostrar audiencia/ubicación) ---
        navHistoryButton.addEventListener('click', async () => { /* ... (la llamada a getHistorySummary es igual) ... */ });

        function renderHistoryList(historyItems) {
            historyListContainer.innerHTML = '';
            if (!historyItems || historyItems.length === 0) {
                historyListContainer.innerHTML = '<p class="has-text-centered">No tienes generaciones guardadas.</p>';
                return;
            }
            const list = document.createElement('div');
            list.classList.add('list', 'is-hoverable');
            historyItems.forEach(item => {
                const listItem = document.createElement('a');
                listItem.classList.add('list-item');
                listItem.dataset.sessionId = item.id;
                const timestampDate = item.timestamp && item.timestamp.seconds ? new Date(item.timestamp.seconds * 1000 + (item.timestamp.nanoseconds || 0) / 1000000) : null;
                const formattedTimestamp = timestampDate ? timestampDate.toLocaleString('es-ES') : 'Fecha desconocida';

                // Mostrar solo los campos relevantes
                listItem.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title"><strong>Tema:</strong> ${item.topic || 'N/A'}</div>
                        <div class="list-item-description">
                            <small><strong>Fecha:</strong> ${formattedTimestamp}</small><br>
                            <small><strong>Tono:</strong> ${item.tone || 'N/A'}</small>
                        </div>
                    </div>
                `;
                listItem.addEventListener('click', () => { /* ... (lógica de selección sin cambios) ... */ });
                list.appendChild(listItem);
            });
            historyListContainer.appendChild(list);
        }
        // ... (closeHistoryModal, cancelHistoryModal, loadHistoryDetailsButton sin cambios en su lógica principal, pero loadHistoryDetailsButton ya no llenará campos de audiencia/ubicación)

        // --- Lógica de Exportación (exportPdfButton y exportCsvButton se mantienen por ahora, pero exportCsv llamará a una función backend que podría necesitar ser diferente si es "todo el historial") ---
        // ... (tu código de exportPdfButton y exportCsvButton se mantiene igual por ahora) ...


        // Inicialización y Burger menu (sin cambios)
        const burger = document.querySelector('.navbar-burger');
        const menu = document.querySelector('.navbar-menu');
        if (burger && menu) { /* ... sin cambios ... */ }
        console.log("Aplicación simplificada de generación de ideas inicializada.");
    </script>
</body>

</html>
